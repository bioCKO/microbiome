#!/usr/bin/perl
#Version 2.0, Date: 2014-11-20, add default template for metagenomeV2.0.
#Version:2.1, Date: 2015-01-26, add option s2
#Version:3.0, Date: 2015-07-13, report for pepiline3.0
#Version:3.0, Date: 2016-04-01, report for pepiline3.2
#Contact: chenjunru[AT]novogene.com lilifeng[AT]novogene.com
use strict;
use Cwd qw(abs_path);
use FindBin qw($Bin);
use File::Basename;
use Getopt::Long;
my %opt;
$opt{outdir}='./';
GetOptions(\%opt,"s2","ipath","vs","type:s","stat:s","outdir:s","resultdir:s","info:s","contact:s",);
($opt{resultdir} && -s $opt{resultdir}  && $opt{stat} && -s $opt{stat}) || die
"usage: perl get_report.pl <resultdir> <out_dir/>\n
    options:
    *-resultdir [str]  input result directory
    --outdir    [str]  output directory,default=./
    *-stat      [str]  stat.info to generate report.html
    *-type      [str]  choose different assembly Methods discription according to deffirent type
    --s2               to creat result directory for two samples(or just 1 sample)
    --ipath            if there is ipath analysis
    --vs               if there is metastasts analysis
    --info      [file] input information of project,format:NHID\\tReportID\\tProject Name
    --contact   [str]  contact name, default=sucong
    \n";
#get scripts
my $tab2json="perl $Bin/tab2json_meta.pl ";
my $html2pdf="$Bin/html2pdf/html2pdf.sh ";
my $combine="perl $Bin/combine_fig.pl";

#get software pathway
use lib "$Bin/../00.Commbin";
my $lib = "$Bin/../../lib";
use PATHWAY;
(-s "$Bin/../../bin/Pathway_cfg.txt") || die"error: can't find config at $Bin/../../bin/, $!\n";
my ($convert,$css,$logo) = get_pathway("$Bin/../../bin/Pathway_cfg.txt",[qw(SVG2XXX KEGG_CSS KEGG_LOGO)],$Bin,$lib);
$convert .= " -t png ";

#get options
my ($id,$report_id,$pro);
if ($opt{info} && -s $opt{info}){
    my $temp=`cat $opt{info}`;
    chomp $temp;
    ($id,$report_id,$pro) = ($temp =~/\t/) ? (split /\t/,$temp) : (split /\s+/,$temp);
}
my $report = ($report_id) ? $report_id : "report";
my $outdir=$opt{outdir};
(-d $outdir) || `mkdir -p $outdir`;
my $resultdir = abs_path($opt{resultdir});
$outdir = abs_path($outdir);
#my $report="$outdir/report";
my %contact=(
    'sucong',['苏聪','15122869190','sucong@novogene.com'],
    'huopianpian',['霍翩翩','18322102992','huopianpian@novogene.com'],
    'yuanyuqi',['袁玉琦','13502035681','yuanyuqi@novogene.com'],
);
$opt{contact} ||= 'yuanyuqi';
#$opt{id} ||= 'NHT100000';
$opt{contact} eq 'pianpian' && ($opt{contact}='huopianpian');
$opt{contact} eq 'yuqi' && ($opt{contact}='yuqi');
$opt{contact} eq 'sucong' || $opt{contact} eq 'huopianpian' || $opt{contact} eq 'yuanyuqi' || die "contact just can be choosed from sucong|huopianpian|yuanyuqi\n";

########################main########################################

###start for get png, json and head
(-s $report) && `rm -rf $report`;
(-s $report) || `mkdir -p $report`;
(-s "$report.tar.gz") && `rm $report.tar.gz`;
`cp -rf $Bin/src/ $report/`;##

## for qc report
`cp -rf $resultdir/01.CleanData/QC_raw_report/ $report/src/ `;

#01.CleanData
my $CleanData_head;
if(-s "$resultdir/01.CleanData/novototal.QCstat.info.xls"){
    `$tab2json $resultdir/01.CleanData/novototal.QCstat.info.xls $report/src/json/clean_data.json`;
    my @CleanData_head=split /\t/,`head -n 1 $resultdir/01.CleanData/novototal.QCstat.info.xls`;
    splice(@CleanData_head,2,1); #delete SeqStrategy
    chomp($CleanData_head[$#CleanData_head]);
    $CleanData_head='                                            colNames:["'.(join "\",\"",@CleanData_head).'"],'."\n".'                                            colModel:['."\n";
    foreach(@CleanData_head){
        $CleanData_head.= "                                                {name:\"$_\",index:\"$_\",width:\"100\",align:\"center\"},\n";
    }
    $CleanData_head .= "                                            ],\n";
}
#02.Assembly
my $Assembly_head;
if(-s "$resultdir/02.Assembly/total.scaftigs.stat.info.xls"){
    `$tab2json $resultdir/02.Assembly/total.scaftigs.stat.info.xls $report/src/json/assembly.json `;
    my @Assembly_head=split /\t/,`head -n 1 $resultdir/02.Assembly/total.scaftigs.stat.info.xls`;
    chomp($Assembly_head[$#$Assembly_head]);
    $Assembly_head='                                            colNames:["'.(join "\",\"",@Assembly_head).'"],'."\n".'                                            colModel:['."\n";
    foreach(@Assembly_head){
        $Assembly_head.= "                                                {name:\"$_\",index:\"$_\",width:\"100\",align:\"center\"},\n";
    }
    $Assembly_head .= "                                            ],\n";
}

my @assembly_picts=split /\s+/,`ls $resultdir/02.Assembly/*/*.len.png`;
my $assembly_picts_name=basename($assembly_picts[0]);
my $assembly_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/02.Assembly/'.$assembly_picts_name.'" alt="'.$assembly_picts_name.'" title="'.$assembly_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
foreach(@assembly_picts){
    `cp -f $_ $report/src/pictures/02.Assembly/`;
    my $name=basename($_);
    $assembly_picts.='<li><a id="example2" href="src/pictures/02.Assembly/'.$name.'" ><img src="src/pictures/02.Assembly/'.$name.'" alt="'.$name.'" title="'.$name.'" /></a></li>'."\n";
}
$assembly_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";


#03.GeneComponet-01 total gene table
my $total_gene_table;
if(-s "$resultdir/03.GenePredict/UniqGenes/Unigenes.CDS.cdhit.fa.stat.xls"){
    $total_gene_table .= "<table>\n<tbody>\n";
    for(`less -S $resultdir/03.GenePredict/UniqGenes/Unigenes.CDS.cdhit.fa.stat.xls`){
        chomp;
        my @or=split/\t/;
        $total_gene_table .= '<tr>';
        foreach(@or){
            $total_gene_table .= '<td>'.$_.'</td>';
        }
        $total_gene_table .= '</tr>';
    }
    $total_gene_table .= '</tbody>'."\n".'</table>'."\n";
}
#(-s "$resultdir/06.GenePredict/GenePredict/Total.gene.CDS.fa.len.png") && `cp -f $resultdir/06.GenePredict/GenePredict/Total.gene.CDS.fa.len.png $report/src/pictures/04.GeneComp/`;

#03.GeneComponet-genestat
(-s "$resultdir/03.GenePredict/UniqGenes/Unigenes.CDS.cdhit.fa.len.png") && `cp -f $resultdir/03.GenePredict/UniqGenes/Unigenes.CDS.cdhit.fa.len.png $report/src/pictures/03.GeneComp/`;
(-s "$resultdir/03.GenePredict/GeneStat/correlation/correlation.heatmap.png") && `cp -f $resultdir/03.GenePredict/GeneStat/correlation/correlation.heatmap.png $report/src/pictures/03.GeneComp/`;
(-s "$resultdir/03.GenePredict/GeneStat/genebox/group.genebox.png") && `cp -f $resultdir/03.GenePredict/GeneStat/genebox/group.genebox.png $report/src/pictures/03.GeneComp/`;
(-s "$resultdir/03.GenePredict/GeneStat/venn/venn_display.png") && `cp -f $resultdir/03.GenePredict/GeneStat/venn/venn_display.png $report/src/pictures/03.GeneComp/`;
(-s "$resultdir/03.GenePredict/GeneStat/core_pan/core.flower.png") && `cp -f $resultdir/03.GenePredict/GeneStat/core_pan/core.flower.png $report/src/pictures/03.GeneComp/`;


##04. taxonomy
if (-s "$resultdir/04.TaxAnnotation/top/figure/p10.dis.png" && -s "$resultdir/04.TaxAnnotation/top/figure/g10.dis.png") {
    `$combine $resultdir/04.TaxAnnotation/top/figure/p10.dis.png $resultdir/04.TaxAnnotation/top/figure/g10.dis.png -ftext 'a,b' > $report/src/pictures/04.Taxonomy/top.pg.svg`;
    `$convert $report/src/pictures/04.Taxonomy/top.pg.svg $report/src/pictures/04.Taxonomy/`;
}
(-s "$resultdir/04.TaxAnnotation/Krona/taxonomy.krona.html") && `cp -f $resultdir/04.TaxAnnotation/Krona/taxonomy.krona.html $report/src/pictures/04.Taxonomy/`;
##(-s "$resultdir/04.TaxAnnotation/Krona/img") && `cp -rf $resultdir/04.TaxAnnotation/Krona/img $report/src/pictures/04.Taxonomy/`;
##(-s "$resultdir/04.TaxAnnotation/Krona/src") && `cp -rf $resultdir/04.TaxAnnotation/Krona/src $report/src/pictures/04.Taxonomy/`;
(-s "$resultdir/04.TaxAnnotation/Krona/taxonomy.krona.html.files") && `cp -rf $resultdir/04.TaxAnnotation/Krona/taxonomy.krona.html.files $report/src/pictures/04.Taxonomy/`;

my %show;
my $workdir = abs_path("$resultdir/../");
##for Metastats
my $tax_dir = "$workdir/04.TaxAnnotation/MicroNR/MicroNR_stat/";
my @tax_list=("species","genus","family","order","class","phylum");
foreach my $i(@tax_list){
    if (-s "$tax_dir/MetaStats/$i/boxplot/top.12.png"){
	    $show{tax_box}=1;
		system"cp -rf $tax_dir/MetaStats/$i/boxplot/top.12.png $report/src/pictures/04.Taxonomy/";
		last;
	}
}
foreach my $i(@tax_list){
    if (-s "$tax_dir/MetaStats/$i/cluster.$i.diff.png"){
	    $show{tax_diff}=1;
		`$combine  $tax_dir/MetaStats/$i/cluster.$i.diff.png $tax_dir/MetaStats/$i/PCA/PCA12_2.png -ftext 'a,b' > $report/src/pictures/04.Taxonomy/tax.ph.svg`;
        `$convert $report/src/pictures/04.Taxonomy/tax.ph.svg $report/src/pictures/04.Taxonomy/`;
	    last;
	}
}


(-s "$resultdir/04.TaxAnnotation/PCA/phylum/PCA12_2.png") && `cp -rf $resultdir/04.TaxAnnotation/PCA/phylum/PCA12_2.png $report/src/pictures/04.Taxonomy/`;
(-s "$resultdir/04.TaxAnnotation/Cluster_Tree/figure/Bar.tree.p10.png") && `cp -rf $resultdir/04.TaxAnnotation/Cluster_Tree/figure/Bar.tree.p10.png $report/src/pictures/04.Taxonomy/`;
if (-s "$resultdir/04.TaxAnnotation/GeneNums.BetweenSamples.heatmap/genus/genus.genenum.heatmap.txt-1.png"  && "$resultdir/04.TaxAnnotation/heatmap/figure/cluster.g.png") {
    `$combine  $resultdir/04.TaxAnnotation/GeneNums.BetweenSamples.heatmap/genus/genus.genenum.heatmap.txt-1.png  $resultdir/04.TaxAnnotation/heatmap/figure/cluster.g.png  -ftext 'a,b' >$report/src/pictures/04.Taxonomy/heatmap.svg`;
    `$convert $report/src/pictures/04.Taxonomy/heatmap.svg $report/src/pictures/04.Taxonomy/`;
}
if (-s "$resultdir/04.TaxAnnotation/Cluster_Tree/figure/Bar.tree.p10.png" && -s "$resultdir/04.TaxAnnotation/PCA/phylum/PCA12_2.png"){
    `$combine  $resultdir/04.TaxAnnotation/Cluster_Tree/figure/Bar.tree.p10.png $resultdir/04.TaxAnnotation/PCA/phylum/PCA12_2.png -ftext 'a,b' > $report/src/pictures/04.Taxonomy/tax.bp.svg`;
    `$convert $report/src/pictures/04.Taxonomy/tax.bp.svg $report/src/pictures/04.Taxonomy/`;
}

#05.FunctionAnontation
## for gene number picts
my $cazy_num_picts="$resultdir/05.FunctionAnnotation/CAZy/CAZy_Anno/cazy.unigenes.num.png";
my $kegg_num_picts="$resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/kegg.unigenes.num.png";
my $eggnog_num_picts="$resultdir/05.FunctionAnnotation/eggNOG/eggNOG_Anno/eggNOG.unigenes.num.png";
my @num_picts=($kegg_num_picts,$eggnog_num_picts,$cazy_num_picts);
my $num_picts_name=basename($num_picts[0]);
my $num_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$num_picts_name.'" alt="'.$num_picts_name.'" title="'.$num_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
foreach(@num_picts){
    `cp -f $_ $report/src/pictures/05.FunctionAnnotation/`;
    my $name=basename($_);
    $num_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
}
$num_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";


##for genenumber heatmp
my $genenum_heatmap_picts;
if (-s "$resultdir/05.FunctionAnnotation/CAZy/GeneNums.BetweenSamples.heatmap/level1/level1.genenum.heatmap.txt-1.png" && -s "$resultdir/05.FunctionAnnotation/KEGG/GeneNums.BetweenSamples.heatmap/level1/level1.genenum.heatmap.txt-1.png" && -s "$resultdir/05.FunctionAnnotation/eggNOG/GeneNums.BetweenSamples.heatmap/level1/level1.genenum.heatmap.txt-1.png") {
    `cp -f $resultdir/05.FunctionAnnotation/CAZy/GeneNums.BetweenSamples.heatmap/level1/level1.genenum.heatmap.txt-1.png $report/src/pictures/05.FunctionAnnotation/CAZy.level1.genenum.heatmap.txt-1.png`;
    my $cazy_genenum_heatmap="$report/src/pictures/05.FunctionAnnotation/CAZy.level1.genenum.heatmap.txt-1.png";
    `cp -f $resultdir/05.FunctionAnnotation/KEGG/GeneNums.BetweenSamples.heatmap/level1/level1.genenum.heatmap.txt-1.png $report/src/pictures/05.FunctionAnnotation/kegg.level1.genenum.heatmap.txt-1.png`;
    my $kegg_genenum_heatmap="$report/src/pictures/05.FunctionAnnotation/kegg.level1.genenum.heatmap.txt-1.png";
    `cp -f $resultdir/05.FunctionAnnotation/eggNOG/GeneNums.BetweenSamples.heatmap/level1/level1.genenum.heatmap.txt-1.png $report/src/pictures/05.FunctionAnnotation/eggNOG.level1.genenum.heatmap.txt-1.png`;
    my $eggnog_genenum_heatmap="$report/src/pictures/05.FunctionAnnotation/eggNOG.level1.genenum.heatmap.txt-1.png";
    my @genenum_heatmap_picts=($kegg_genenum_heatmap,$cazy_genenum_heatmap,$eggnog_genenum_heatmap);
    my $genenum_heatmap_name=basename($genenum_heatmap_picts[0]);
    $genenum_heatmap_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$num_picts_name.'" alt="'.$num_picts_name.'" title="'.$num_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
    foreach(@genenum_heatmap_picts){
        my $name=basename($_);
        $genenum_heatmap_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
    }
    $genenum_heatmap_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";
}


## for function relative abundance picts
`cp -f $resultdir/05.FunctionAnnotation/CAZy/CAZy_Anno/Unigenes.level1.bar.png $report/src/pictures/05.FunctionAnnotation/CAZy.Unique.Genes.level1.bar.png`;
my $cazy_rel_picts="$report/src/pictures/05.FunctionAnnotation/CAZy.Unique.Genes.level1.bar.png";
`cp -f $resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/Unigenes.level1.bar.png  $report/src/pictures/05.FunctionAnnotation/KEGG.Unique.Genes.level1.bar.png`;
my $kegg_rel_picts="$report/src/pictures/05.FunctionAnnotation/KEGG.Unique.Genes.level1.bar.png";
`cp -f $resultdir/05.FunctionAnnotation/eggNOG/eggNOG_Anno/Unigenes.level1.bar.png $report/src/pictures/05.FunctionAnnotation/eggNOG.Unique.Genes.level1.bar.png`;
my $eggnog_rel_picts="$report/src/pictures/05.FunctionAnnotation/eggNOG.Unique.Genes.level1.bar.png";
my @rel_picts=($kegg_rel_picts,$eggnog_rel_picts,$cazy_rel_picts);
my $rel_picts_name=basename($rel_picts[0]);
my $rel_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$rel_picts_name.'" alt="'.$rel_picts_name.'" title="'.$rel_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
foreach(@rel_picts){
    my $name=basename($_);
    $rel_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
}
$rel_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";

## for function cluster picts
my $cluster_picts;
if (-s "$resultdir/05.FunctionAnnotation/CAZy/heatmap/cluster.level2.png" && -s "$resultdir/05.FunctionAnnotation/KEGG/heatmap/cluster.ko.png" && -s "$resultdir/05.FunctionAnnotation/eggNOG/heatmap/cluster.og.png") {
    `cp -f $resultdir/05.FunctionAnnotation/CAZy/heatmap/cluster.level2.png $report/src/pictures/05.FunctionAnnotation/CAZy.cluster.level2.png`;
    my $cazy_cluster_picts="$report/src/pictures/05.FunctionAnnotation/CAZy.cluster.level2.png";
    `cp -f $resultdir/05.FunctionAnnotation/KEGG/heatmap/cluster.ko.png $report/src/pictures/05.FunctionAnnotation/KEGG.cluster.ko.png`;
    my $kegg_cluster_picts="$report/src/pictures/05.FunctionAnnotation/KEGG.cluster.ko.png";
    `cp -f $resultdir/05.FunctionAnnotation/eggNOG/heatmap/cluster.og.png $report/src/pictures/05.FunctionAnnotation/eggNOG.cluster.og.png`;
    my $eggnog_cluster_picts="$report/src/pictures/05.FunctionAnnotation/eggNOG.cluster.og.png";
    my @cluster_picts=($kegg_cluster_picts,$eggnog_cluster_picts,$cazy_cluster_picts);
    my $cluster_picts_name=basename($cluster_picts[0]);
    $cluster_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$cluster_picts_name.'" alt="'.$cluster_picts_name.'" title="'.$cluster_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
    foreach(@cluster_picts){
        my $name=basename($_);
        $cluster_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
    }
    $cluster_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";
}

## function pca analysis
my $pca_picts;
if(-s "$resultdir/05.FunctionAnnotation/CAZy/PCA/level2/PCA12_2.png" && -s "$resultdir/05.FunctionAnnotation/eggNOG/PCA/og/PCA12_2.png" && -s "$resultdir/05.FunctionAnnotation/KEGG/PCA/ko/PCA12_2.png"){
    `cp -f $resultdir/05.FunctionAnnotation/CAZy/PCA/level2/PCA12_2.png $report/src/pictures/05.FunctionAnnotation/CAZy.PCA12_2.png`;
    my $cazy_pca_picts="$report/src/pictures/05.FunctionAnnotation/CAZy.PCA12_2.png";
    `cp -f $resultdir/05.FunctionAnnotation/KEGG/PCA/ko/PCA12_2.png $report/src/pictures/05.FunctionAnnotation/KEGG.PCA12_2.png`;
    my $kegg_pca_picts="$report/src/pictures/05.FunctionAnnotation/KEGG.PCA12_2.png";
    `cp -rf $resultdir/05.FunctionAnnotation/eggNOG/PCA/og/PCA12_2.png $report/src/pictures/05.FunctionAnnotation/eggNOG.PCA12_2.png`;
    my $eggnog_pca_picts="$report/src/pictures/05.FunctionAnnotation/eggNOG.PCA12_2.png";
    my @pca_picts=($kegg_pca_picts,$eggnog_pca_picts,$cazy_pca_picts);
    my $pca_picts_name=basename($pca_picts[0]);
    $pca_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$pca_picts_name.'" alt="'.$pca_picts_name.'" title="'.$pca_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
    foreach(@pca_picts){
        my $name=basename($_);
        $pca_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
    }
    $pca_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";
}

## for function cluster
my $circ_picts;
if(-s "$resultdir/05.FunctionAnnotation/CAZy/CAZy_Anno/Unigenes.level1.bar.tree.png" && -s "$resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/Unigenes.level1.bar.tree.png" && -s "$resultdir/05.FunctionAnnotation/eggNOG/eggNOG_Anno//Unigenes.level1.bar.tree.png"){
    `cp -f $resultdir/05.FunctionAnnotation/CAZy/CAZy_Anno/Unigenes.level1.bar.tree.png $report/src/pictures/05.FunctionAnnotation/CAZy.Unique.Genes.level1.bar.tree.png`;
    my $cazy_circ_picts="$report/src/pictures/05.FunctionAnnotation/CAZy.Unique.Genes.level1.bar.tree.png";
    `cp -f $resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/Unigenes.level1.bar.tree.png $report/src/pictures/05.FunctionAnnotation/KEGG.Unique.Genes.level1.bar.tree.png`;
    my $kegg_circ_picts="$report/src/pictures/05.FunctionAnnotation/KEGG.Unique.Genes.level1.bar.tree.png";
    `cp -f $resultdir/05.FunctionAnnotation/eggNOG/eggNOG_Anno//Unigenes.level1.bar.tree.png $report/src/pictures/05.FunctionAnnotation/eggNOG.Unique.Genes.level1.bar.tree.png`;
    my $eggnog_circ_picts="$report/src/pictures/05.FunctionAnnotation/eggNOG.Unique.Genes.level1.bar.tree.png";
    my @circ_picts=($kegg_circ_picts,$eggnog_circ_picts,$cazy_circ_picts);
    my $circ_picts_name=basename($circ_picts[0]);
    $circ_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$circ_picts_name.'" alt="'.$circ_picts_name.'" title="'.$circ_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
    foreach(@circ_picts){
        my $name=basename($_);
        $circ_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
    }
    $circ_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";
}

##for metastat anlysis
my (@metastat_picts,@meta_ph_picts,$metastat_picts,$meta_ph_picts);
my($kegg_meta_picts,$kegg_ph_picts,$cazy_meta_picts,$cazy_ph_picts,$eggnog_meta_picts,$eggnog_ph_picts);
###KEGG
my $kegg_dir="$workdir/05.FunctionAnnotation/KEGG/KEGG_stat/Metastats/";
my @kegg_list=("ko","level1","level2","level3","ec");
foreach my $i(@kegg_list){
    if(-s "$kegg_dir/$i/boxplot/top.12.png"){
	   $show{kegg_box} =1;
	   `cp -f $kegg_dir/$i/boxplot/top.12.png $report/src/pictures/05.FunctionAnnotation/KEGG.top.12.png`;
	   last;
	}
}
$show{kegg_box} && ($kegg_meta_picts="$report/src/pictures/05.FunctionAnnotation/KEGG.top.12.png") && (push @metastat_picts,$kegg_meta_picts);

foreach my $i(@kegg_list){
    if(-s "$kegg_dir/$i/cluster.$i.diff.png"){
	   $show{kegg_diff} =1;
	   `$combine $kegg_dir/$i/cluster.$i.diff.png $kegg_dir/$i/PCA/PCA12_2.png -ftext 'a,b' > $report/src/pictures/05.FunctionAnnotation/kegg_ph.svg`;
       `$convert $report/src/pictures/05.FunctionAnnotation/kegg_ph.svg $report/src/pictures/05.FunctionAnnotation/`;
	   last;
	}
}
$show{kegg_diff} && ($kegg_ph_picts="$report/src/pictures/05.FunctionAnnotation/kegg_ph.png") && (push @meta_ph_picts,$kegg_ph_picts);

###CAZY
my $cazy_dir="$workdir/05.FunctionAnnotation/CAZy/CAZy_stat/Metastats/";
my @cazy_list=("level2","level1","EC");
foreach my $i(@cazy_list){
    if(-s "$cazy_dir/$i/boxplot/top.12.png"){
	    $show{cazy_box}=1;
		`cp -f $cazy_dir/$i/boxplot/top.12.png $report/src/pictures/05.FunctionAnnotation/CAZy.top.12.png`;
		last;
	}
}
$show{cazy_box} && ($cazy_meta_picts="$report/src/pictures/05.FunctionAnnotation/CAZy.top.12.png") && (push @metastat_picts,$cazy_meta_picts);

foreach my $i(@cazy_list){
    if(-s "$cazy_dir/$i/cluster.$i.diff.png"){
	    $show{cazy_diff} =1;
        `$combine $cazy_dir/$i/cluster.$i.diff.png $cazy_dir/$i/PCA/PCA12_2.png -ftext 'a,b' >$report/src/pictures/05.FunctionAnnotation/cazy_ph.svg`; 
        `$convert $report/src/pictures/05.FunctionAnnotation/cazy_ph.svg report/src/pictures/05.FunctionAnnotation/`;
        last;
    }
}
$show{cazy_diff} && ($cazy_ph_picts="$report/src/pictures/05.FunctionAnnotation/cazy_ph.png") && (push @meta_ph_picts,$cazy_ph_picts);
	
###eggNOG
my $egg_dir="$workdir/05.FunctionAnnotation/eggNOG/eggNOG_stat/Metastats/";
my @egg_list=("og","level2","level1");
foreach my $i(@egg_list){
    if(-s "$egg_dir/$i/boxplot/top.12.png"){
	    $show{egg_box}=1;
		`cp -f $egg_dir/$i/boxplot/top.12.png $report/src/pictures/05.FunctionAnnotation/eggNOG.top.12.png`;
		last;
	}
}
$show{egg_box} && ($eggnog_meta_picts="$report/src/pictures/05.FunctionAnnotation/eggNOG.top.12.png") && (push @metastat_picts,$eggnog_meta_picts);

foreach my $i(@egg_list){
    if(-s "$egg_dir/$i/cluster.$i.diff.png"){
	    $show{egg_diff}=1;
		`$combine $egg_dir/$i/cluster.$i.diff.png $egg_dir/$i/PCA/PCA12_2.png -ftext 'a,b' > $report/src/pictures/05.FunctionAnnotation/eggnog_ph.svg`;
        `$convert $report/src/pictures/05.FunctionAnnotation/eggnog_ph.svg $report/src/pictures/05.FunctionAnnotation/`;
		last;
	}
}
$show{egg_diff} && ($eggnog_ph_picts="$report/src/pictures/05.FunctionAnnotation/eggnog_ph.png") && (push @meta_ph_picts,$eggnog_ph_picts);

###show box plot
my $box=@metastat_picts;
if ($box) {
    $show{fun_box}=1;
    my $metastat_picts_name=basename($metastat_picts[0]);
    $metastat_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$metastat_picts_name.'" alt="'.$metastat_picts_name.'" title="'.$metastat_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
    foreach(@metastat_picts){
        my $name=basename($_);
        $metastat_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
    }
    $metastat_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";
}

###show diff plot
my $diff=@meta_ph_picts;
if ($diff) {
    $show{fun_diff}=1;
    my $meta_ph_picts_name=basename($meta_ph_picts[0]);
    $meta_ph_picts='    <div class="albumSlider">'."\n".'       <div class="fullview"> <img src="src/pictures/05.FunctionAnnotation/'.$meta_ph_picts_name.'" alt="'.$meta_ph_picts_name.'" title="'.$meta_ph_picts_name.'" /></div>'."\n".'        <div class="slider">'."\n".'            <div class="button movebackward" title="向上滚动"></div>'."\n".'            <div class="imglistwrap">'."\n".'                <ul class="imglist">';
    foreach(@meta_ph_picts){
        my $name=basename($_);
        $meta_ph_picts.='<li><a id="example2" href="src/pictures/05.FunctionAnnotation/'.$name.'" ><img src="src/pictures/05.FunctionAnnotation/'.$name.'" alt="'.$name.'"'.' title="'.$name.'" /></a></li>'."\n";
    }
    $meta_ph_picts.='                </ul>'."\n".'            </div>'."\n".'            <div class="button moveforward" title="向下滚动"></div>'."\n".'        </div>'."\n".'    </div>'."\n";
}

if (-s "$resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/kegg.unigenes.num.png" && -s "$resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/Unigenes.level1.bar.png" && -s "$resultdir/05.FunctionAnnotation/KEGG/heatmap/cluster.ko.png" && -s "$resultdir/05.FunctionAnnotation/KEGG/PCA/ko/PCA12_2.png") {
    `$combine $resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/kegg.unigenes.num.png $resultdir/05.FunctionAnnotation/KEGG/KEGG_Anno/Unigenes.level1.bar.png -ftext 'a,b' > $report/src/pictures/05.FunctionAnnotation/kegg.com.svg`;
        `$convert $report/src/pictures/05.FunctionAnnotation/kegg.com.svg $report/src/pictures/05.FunctionAnnotation/`;
        `$combine $resultdir/05.FunctionAnnotation/KEGG/heatmap/cluster.ko.png $resultdir/05.FunctionAnnotation/KEGG/PCA/ko/PCA12_2.png -ftext 'c,d' > $report/src/pictures/05.FunctionAnnotation/kegg.com2.svg`;
        `$convert $report/src/pictures/05.FunctionAnnotation/kegg.com2.svg $report/src/pictures/05.FunctionAnnotation/`;
}

###end for get png, json and head
my $date = `date +"%Y"-"%m"-"%d"`;
open(OUT,">$report/report.detail.html");
########################report########################################
print OUT  << "XHTML"
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd" >
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<TITLE> 诺禾致源 Metagenome 分析结题报告 </TITLE>
<META NAME="Author" CONTENT="yanjun\@novogene.cn">
<META NAME="Version" CONTENT="201307v3">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" media="screen" href="src/css/ui.jqgrid.css" />
<link rel="stylesheet" type="text/css" media="screen" href="src/css/smoothness/jquery.ui.all.css" />
<script src="src/js/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="src/js/i18n/grid.locale-en.js" type="text/javascript"></script>
<script type="text/javascript" src="src/js/jquery.jqGrid.min.js"></script>  
<link rel="stylesheet" type="text/css" href="src/css/text.css">
<link rel="StyleSheet" href="src/js/tree/tree.css" type="text/css">
<link rel="stylesheet" type="text/css" href="src/js/fancybox/jquery.fancybox-1.3.4.css" media="screen" />
<link rel="stylesheet" href="src/css/style.css" />
<script src="src/js/scrollTop.js" type="text/javascript"></script>
<script src="src/js/common.js" type="text/javascript"></script>
<script src="src/js/jquery.albumSlider.min.js" type="text/javascript"></script>
<script type="text/javascript" src="src/js/tree/tree.js"></script>
<script type="text/javascript" src="src/js/fancybox/jquery.mousewheel-3.0.4.pack.js"></script>
<script type="text/javascript" src="src/js/fancybox/jquery.fancybox-1.3.4.pack.js"></script>

<script type="text/javascript">
    \$(document).ready(function() {
        /*
        *   Examples - images
        */

        \$("a#example1").fancybox();

        \$("a#example2").fancybox({
            'overlayShow'   : false,
            'transitionIn'  : 'elastic',
            'transitionOut' : 'elastic'
        });
        \$("a#example3").fancybox({
            'transitionIn'  : 'none',
            'transitionOut' : 'none'    
        });

        \$("a#example4").fancybox({
            'opacity'       : true,
            'overlayShow'   : false,
            'transitionIn'  : 'elastic',
            'transitionOut' : 'none'
        });

        \$("a#example5").fancybox();

        \$("a#example6").fancybox({
            'titlePosition'     : 'outside',
            'overlayColor'      : '#000',
            'overlayOpacity'    : 0.9
        });

        \$("a#example7").fancybox({
            'titlePosition' : 'inside'
        });

        \$("a#example8").fancybox({
            'titlePosition' : 'over'
        });

        \$("a[rel=example_group]").fancybox({
            'transitionIn'      : 'none',
            'transitionOut'     : 'none',
            'titlePosition'     : 'over',
            'titleFormat'       : function(title, currentArray, currentIndex, currentOpts) {
                return '<span id="fancybox-title-over">Image ' + (currentIndex + 1) + ' / ' + currentArray.length + (title.length ? ' &nbsp; ' + title : '') + '</span>';
            }
        });

        /*
        *   Examples - various
        */

        \$("#various1").fancybox({
            'titlePosition'     : 'inside',
            'transitionIn'      : 'none',
            'transitionOut'     : 'none'
        });

        \$("#various2").fancybox();

        \$("#various3").fancybox({
            'width'             : '75%',
            'height'            : '75%',
            'autoScale'         : false,
            'transitionIn'      : 'none',
            'transitionOut'     : 'none',
            'type'              : 'iframe'
        });

        \$("#various4").fancybox({
            'padding'           : 0,
            'autoScale'         : false,
            'transitionIn'      : 'none',
            'transitionOut'     : 'none'
        });
    });
</script>

<style media="print">
.noprint {DISPLAY: none;}
</style>

<div class="noprint">
<div style="display: block;" id="goTopBtn">
<a class="backtotop" title="回顶部"><img src="src/images/goTop.jpg" width="30" height="30" class="back-tip"/></a>
</div>
</div>

<script type="text/javascript"> 
function displaySubMenu(li) { 
var subMenu = li.getElementsByTagName("ul")[0]; 
subMenu.style.display = "block"; 
} 
function hideSubMenu(li) { 
var subMenu = li.getElementsByTagName("ul")[0]; 
subMenu.style.display = "none"; 
} 
</script> 

<script type="text/javascript">
\$(function(){
    //纵向，默认，移动间隔2
    \$('div.albumSlider').albumSlider();
    //横向设置
    \$('div.albumSlider-h').albumSlider({direction:'h',step:3});
});
</script>   

<script type="text/javascript"> <!--assembly-->
    jQuery().ready(function (){
        jQuery("#table_assembly").jqGrid({
                                            url:"src/json/assembly.json",
                                            datatype:"json",
XHTML
;
print OUT "$Assembly_head";
print OUT << "XHTML"
                                            loadonce:true,
                                            rowNum:10,
                                            rowList:[5,10,15,20,50,100,150,200,300,500,1000],
                                            shrinkToFit:true,
                                            autowidth:false,
                                            jsonReader:{
                                                    root:"src/json/assembly.json",
                                                    repeatitems:false,
                                            },
                                            sortable:false,
                                            pager:jQuery('#page_assembly'),
                                            viewrecords:true,
                                            caption:"组装结果 scaftigs 的统计",
                                            height:"100%",
                                            width:"100%",
            })
     })
</script>   

<script type="text/javascript"> <!--clean data-->
    jQuery().ready(function (){
        jQuery("#table_clean_Data").jqGrid({
                                            url:"src/json/clean_data.json",
                                            datatype:"json",
XHTML
;
print OUT "$CleanData_head";
print OUT << "XHTML"
                                            loadonce:true,
                                            rowNum:10,
                                            rowList:[5,10,15,20,50,100,150,200,300,500,1000],
                                            shrinkToFit:true,
                                            autowidth:false,
                                            jsonReader:{
                                                    root:"src/json/clean_data.json",
                                                    repeatitems:false,
                                            },
                                            sortable:false,
                                            pager:jQuery('#page_clean_Data'),
                                            viewrecords:true,
                                            caption:"数据预处理统计表",
                                            height:"100%",
                                            width:"100%",
            })
     })
</script>   

</head>
<body>

<!---------------------------------------- Menu bar ------------------------------------------>
<div class="noprint">
    <div class="menu">
        <ul class="main_menu">
            <li onmouseover="displaySubMenu(this)" onmouseout="hideSubMenu(this)"><a href="#1 概述">概述</a></li>
            <li><a href="#2 项目流程">项目流程</a>
                <ul id="menu_list">
                    <li><a href="#2.1 建库测序流程">建库测序流程</a></li>
                    <li><a href="#2.2 信息分析流程">信息分析流程</a></li>
                </ul>
            </li>
            <li onmouseover="displaySubMenu(this)" onmouseout="hideSubMenu(this)"><a href="#3 分析结果">分析结果</a>
                <ul id="menu_list">
                    <li><a href="#3.1 测序数据预处理">测序数据预处理</a></li>
                    <li><a href="#3.2 Metagenome 组装">Metagenome 组装</a></li>
                    
                    <li><a href="#3.3 基因预测及丰度分析">基因预测及丰度分析</a>
                    </li>
                    <li><a href="#3.4 物种注释">物种注释</a>
                    </li>
                    <li><a href="#3.5 功能注释">功能注释</a>
                    </li>
                </ul>
            </li>
            <li><a href="#参考文献">参考文献</a></li>
            <li onmouseover="displaySubMenu(this)" onmouseout="hideSubMenu(this)"><a href="#附录">附录</a>
                <ul id="menu_list">
                    <li><a href="./src/images/Sequencing_Methods.pdf" title="点击打开" target="_blank">方法描述/Methods</a></li>
                    <li><a href="./src/images/Result_Meta.pdf" title="点击打开" target="_blank">交付文件说明</a></li>
                    <li><a href="./src/images/novo_format.pdf" title="点击打开" target="_blank">常见数据格式</a></li>
                    <li><a href="#相关软件及链接">使用软件说明</a></li>
                    <li><a href="#备注">备注</a></li>
                </ul>
            </li>
        </ul>
        <input type="button" class="close" title="显示/隐藏"></input>
    </div>
</div>
<!--menu over-->

<!---------------------------------------- 目录 ---------------------------------------------->
<div id="page">
    <p><a name="home"><img class="normal" src="src/images/logo.png" /></a><h1>诺禾致源 Metagenome 分析结题报告</h1></p>
    <p class="paragraph" align="left">合同编号：$id</p>
    <p class="paragraph" align="left">合同名称：$pro</p>
    <p class="paragraph" align="left">报告时间：$date</p>
    <p class="paragraph" align="left">报告编号：$report_id</p>
   
XHTML
;
my($catalog,$description,$literature)=&get_html;
print OUT "$catalog</div>\n$description";
my $print_literature=&get_literature(@{$literature});
print OUT <<"XHTML"
<!-------------------------------------------- 参考文献 ------------------------------------------->
<div id="page">
<p class="head"><a href="#home" title = "返回首页"><img class="logo" align="left" src="src/images/logo.png" /></a>
<a name="参考文献">北京诺禾致源生物信息科技有限公司</a>
<hr />
</p><br />
<h2>四、参考文献</h2>
<p class="ref">
    $print_literature
XHTML
;
print OUT << "XHTML"
</p>
</div>

<!-------------------------------------------- 附录 --------------------------------------------->
<p class="head"><a href="#home" title = "返回首页"><img class="logo" align="left" src="src/images/logo.png" /></a>
<a name="附录">北京诺禾致源生物信息科技有限公司</a>
<hr />
</p><br />
<h2>五、附录</h2>
<a name="方法描述/Methods"><h3>5.1　方法描述/Methods</h3></a>
<p class="paragraph">方法描述/Methods：<a href="./src/images/Sequencing_Methods.pdf" title="点击打开" target="_blank">PDF</a></p>

<a name="交付文件目录列表"><h3>5.2　交付文件目录列表</h3></a>
XHTML
;

print OUT << "XHTML"
    <p class="paragraph">交付文件说明：<a href="./src/images/Result_Meta.pdf" title="点击打开" target="_blank">PDF</a></p>
XHTML
; 

print OUT << "XHTML"
<a name="常见数据格式说明"><h3>5.3　常见数据格式说明</h3></a>
<p class="paragraph">常见数据格式说明：<a href="./src/images/novo_format.pdf" title="点击打开" target="_blank">PDF</a></p>

<a name="相关软件及链接"><h3>5.4　相关软件及链接</h3></a>
<p class="paragraph">SOAP denovo(Version 2.21)：<a href="http://soap.genomics.org.cn/soapdenovo.html">http://soap.genomics.org.cn/soapdenovo.html</a></p>
<p class="paragraph">SoapAligner( Version: 2.21 ): <a href="http://soap.genomics.org.cn/soapaligner.html">http://soap.genomics.org.cn/soapaligner.html</a></p>
<p class="paragraph">MetaGeneMark（Version 2.10）:<a href="http://exon.gatech.edu/GeneMark/metagenome/Prediction">http://exon.gatech.edu/GeneMark/metagenome/Prediction</a></p>
<p class="paragraph">CD-HIT（Version：4.5.8): <a href="http://www.bioinformatics.org/cd-hit/">http://www.bioinformatics.org/cd-hit/</a></p>

<a name="备注"><h3>5.5　备注</h3></a>
<p class="paragraph">结果文件建议使用Excel或者EditPlus等专业文本编辑器打开。</p>
<p class="paragraph">推荐使用火狐浏览器进行网页版结题报告浏览，下载地址：<a href="http://www.firefox.com.cn/download/">http://www.firefox.com.cn/download/</a></p>
<p class="paragraph">点击Novogene图标或者右下角按钮可以返回首页。</p>
<!----------------------------------------------- End -------------------------------------------->
</body>
</html>
XHTML
;
close OUT;

my $index_html="$report/report.html";
&get_index($report,$opt{stat},$index_html,"$resultdir/..");

`tar -hcvf report.tar.gz report`;

sub get_description{
    my($des,)=@_;
    my $get_description=join("</p>\n<p class=\"paragraph\">",(split/\n/,$des));
    $get_description = "<p class=\"paragraph\">$get_description</p>";
    return$get_description;
}

sub get_html{
    my $mulu='1 概述
    2 项目流程
    2.1 建库测序流程
    2.2 信息分析流程
    3 分析结果
    3.1 测序数据预处理
    3.2 Metagenome 组装
    3.3 基因预测及丰度分析
    3.3.1 基因预测及丰度分析基本步骤
    3.3.2 gene catalogue 基本信息统计
    ';
    my %return_hash=(
    '概述','1',
    '项目流程','2',
    '建库测序流程','2.1',
    '信息分析流程','2.2',
    '分析结果','3',
    '测序数据预处理','3.1',
    'Metagenome 组装','3.2',
    '基因预测及丰度分析','3.3',
    '基因预测及丰度分析基本步骤','3.3.1',
    'gene catalogue 基本信息统计','3.3.2',
    '物种注释','3.4',
    '物种注释基本步骤','3.4.1',
    'Krona 分析','3.4.2',
    '物种相对丰度柱形图分析','3.4.3',
    '功能注释','3.5',
    '功能注释基本步骤','3.5.1',
    '注释基因数目分析','3.5.2',
    '功能相对丰度柱形图分析','3.5.3',
    '参考文献','4',
    '附录','5',
    '方法描述/Methods','5.1',
    '交付文件目录列表','5.2',
    '常见数据格式说明','5.3',
    '相关软件及链接','5.4',
    '备注','5.5',
    );
    my($a,$b,$c)=(3,3,2); 
    if((-s "$resultdir/03.GenePredict/GeneStat/core_pan/pan.gene.png" && -s "$resultdir/03.GenePredict/GeneStat/core_pan/core.gene.png") || -s  "$resultdir/03.GenePredict/GeneStat/core_pan/core.flower.png"){
        $mulu .= "$a.$b.".++$c." core-pan 基因分析\n";
        $return_hash{'core-pan 基因分析'}="$a.$b.$c";
    }
    if (-s "$resultdir/03.GenePredict/GeneStat/genebox/group.genebox.png"){
         $mulu .= "$a.$b.".++$c." 组间基因数目分析\n";
         $return_hash{'组间基因数目分析'}="$a.$b.$c";
    }
    if( -s "$resultdir/03.GenePredict/GeneStat/venn/venn_display.png"){
        $mulu .= "$a.$b.".++$c." 基因数目韦恩图分析\n";
        $return_hash{'基因数目韦恩图分析'}="$a.$b.$c";
    }
    if (-s "$resultdir/03.GenePredict/GeneStat/correlation/correlation.heatmap.png"){
        $mulu .= "$a.$b.".++$c." 样品间相关性分析\n";
        $return_hash{'样品间相关性分析'}="$a.$b.$c";
    };
    $mulu .=
    '3.4 物种注释
    3.4.1 物种注释基本步骤
    3.4.2 Krona 分析
    3.4.3 物种相对丰度柱形图分析
    ';
    ($a,$b,$c)=(3,4,3); 
    if (!$opt{s2}){
        $mulu .= "$a.$b.".++$c." 基因数目及相对丰度聚类分析\n";
        $return_hash{'基因数目及相对丰度聚类分析'}="$a.$b.$c";
        $mulu .= "$a.$b.".++$c." 物种主成分分析(PCA)\n" ;
        $return_hash{'物种主成分分析(PCA)分析'}="$a.$b.$c";
        $mulu .= "$a.$b.".++$c." 样品聚类分析\n";
        $return_hash{'样品聚类分析taxa'}="$a.$b.$c";
    }
    if ($opt{vs} && -s "$report/src/pictures/04.Taxonomy/tax.ph.png" && -s "$report/src/pictures/04.Taxonomy/top.12.png"){
        $mulu .= "$a.$b.".++$c." 物种显著性差异分析\n";
        $return_hash{'物种显著性差异分析'}="$a.$b.$c";
    }
    $mulu .= 
    '3.5 功能注释
    3.5.1 功能注释基本步骤
    3.5.2 注释基因数目分析
    3.5.3 功能相对丰度柱形图分析
    ';
    ($a,$b,$c)=(3,5,3); 
    if (!$opt{s2}){
        $mulu .= "$a.$b.".++$c." 功能丰度聚类分析\n" ;
        $return_hash{'功能丰度聚类分析'}="$a.$b.$c";
        $mulu .= "$a.$b.".++$c." 功能主成分分析 (PCA)\n" ;
        $return_hash{'功能主成分分析 (PCA)分析'}="$a.$b.$c";
        $mulu .= "$a.$b.".++$c." 样品聚类分析\n" ;
        $return_hash{'样品聚类分析'}="$a.$b.$c";
    }
    if( -s "$resultdir/05.FunctionAnnotation/eggNOG/NOG.Tax/eggNOG.tax.unigene.num.png"){
        `cp -f $resultdir/05.FunctionAnnotation/eggNOG/NOG.Tax/eggNOG.tax.unigene.num.png $report/src/pictures/05.FunctionAnnotation/eggNOG.tax.unigene.num.png`;
        `cp -f $resultdir/05.FunctionAnnotation/eggNOG/NOG.Tax/eggNOG.tax.unigene.num.svg $report/src/pictures/05.FunctionAnnotation/eggNOG.tax.unigene.num.svg`;
        $mulu .= "$a.$b.".++$c." OG 物种归属分析\n";
        $return_hash{'OG 物种归属分析'}="$a.$b.$c";
    }
    if( $opt{vs}){
        $mulu .= "$a.$b.".++$c." 功能显著性差异分析\n" ;
        $return_hash{'功能显著性差异分析'}="$a.$b.$c";
        if (-s "$resultdir/05.FunctionAnnotation/eggNOG/MetaStats/og/og.trees/og.trees.html") {
            $mulu .= "$a.$b.".++$c." 差异 OG 的物种进化分析\n"; 
            $return_hash{'差异 OG 的物种进化分析'}="$a.$b.$c";
            (-s "$report/src/pictures/05.FunctionAnnotation/og.trees/src") || `mkdir -p $report/src/pictures/05.FunctionAnnotation/og.trees/src`;
            `cp -rf $resultdir/05.FunctionAnnotation/eggNOG/MetaStats/og/og.trees/og.trees.html $report/src/pictures/05.FunctionAnnotation/og.trees/`;
            `cp -rf $css $report/src/pictures/05.FunctionAnnotation/og.trees/src/`;
            `cp -rf $logo $report/src/pictures/05.FunctionAnnotation/og.trees/src/`;

        }
    }
    if( $opt{ipath} && -s "$resultdir/05.FunctionAnnotation/KEGG/pathwaymaps.report/"){
        $mulu .= "$a.$b.".++$c." 代谢通路分析\n";
        $return_hash{'代谢通路分析'}="$a.$b.$c";
        `mkdir -p $report/src/pictures/05.FunctionAnnotation/pathwaymaps/`;
        `cp -rf $resultdir/05.FunctionAnnotation/KEGG/pathwaymaps.report/* $report/src/pictures/05.FunctionAnnotation/pathwaymaps/`;
    }
    $mulu .=
    '4 参考文献
    5 附录
    5.1 方法描述/Methods
    5.2 交付文件目录列表
    5.3 常见数据格式说明
    5.4 相关软件及链接
    5.5 备注
    ';
    my $return='<p class="paragraph">
        <dl>'."\n";
    my@catalog=split/\n+/,$mulu;
    my $flag=0;
    my $flag2=0;
    foreach $catalog(@catalog){
        $catalog=~s/^\s+//;
        if ($catalog=~/^\d+ /) {
            $return .= "</dt>\n" if ($flag==1);
            $return .= "</dl></dt>\n"  if $flag2==1 && $flag==0;
            $return .= "<dt><a href=\"#$catalog\">$catalog</a>\n";
            $flag=1;
        }elsif($catalog=~/^\d+\.\d+ /){
            $return .= "<dl class=\"alt\">\n" if $flag==1;
            $return .= "<dd><a href=\"#$catalog\">$catalog</a></dd>\n";
            $flag=0;
            $flag2=1;
        }elsif($catalog=~/^\d+\.\d+\.\d+ /){
            $return .= "<dl class=\"alt\">\n" if $flag==1;
            $return .= "<dd><a href=\"#$catalog\">&nbsp;&nbsp;&nbsp;&nbsp;$catalog</a></dd>\n";
            $flag=0;
            $flag2=1;
        }
    }
    $return .= "</dl></dt><br /><br /></p>\n" ;
    my $description=\%return_hash;
    my $core_pan;
    if (-s "$resultdir/03.GenePredict/GeneStat/core_pan/pan.gene.png" && -s "$resultdir/03.GenePredict/GeneStat/core_pan/core.gene.png"){
    `$combine -wn 2 $resultdir/03.GenePredict/GeneStat/core_pan/core.gene.png $resultdir/03.GenePredict/GeneStat/core_pan/pan.gene.png -ftext 'a,b' > $report/src/pictures/03.GeneComp/combine.gene.svg`;
    `$convert  $report/src/pictures/03.GeneComp/combine.gene.svg $report/src/pictures/03.GeneComp/`;
    $core_pan='<p class="paragraph">从基因在各样品中的丰度表出发，可以获得各样品的基因数目信息，通过随机抽取不同数目的样品，可以获得不同数目样品组合间的基因数目，由此我们构建和绘制了 Core 和 Pan 基因的稀释曲线，图片展示如下：</p>
    <p class="center">
    <a href="src/pictures/03.GeneComp/combine.gene.png"><img  src="src/pictures/03.GeneComp/combine.gene.png" width="70%" height="70%"/></a>
    </p>
    <p class="name">图 3-3-3 core-pan 基因稀释曲线</p>
    <p class="premark">说明：a) Core基因稀释曲线；b) Pan基因稀释曲线。图中，横坐标表示抽取的样品个数；纵坐标表示抽取的样品组合的基因数目。</p>';
    }elsif(-s "$resultdir/03.GenePredict/GeneStat/core_pan/core.flower.png"){
    `cp -f $resultdir/03.GenePredict/GeneStat/core_pan/core.flower.png $report/src/pictures/03.GeneComp/`;
    $core_pan='<p class="paragreph">从基因在各样品中的丰度表出发，可以获得各样品的基因数目信息，由此绘制了基因数目花瓣图，展示结果如下：<p>
    <p class="center">
    <a href="src/pictures/03.GeneComp/core.flower.png"><img  src="src/pictures/03.GeneComp/core.flower.png" width="40%" height="40%"/></a>
    </p>
    <p class="name">图 3-3-3 基因数目花瓣图及基因数目箱图</p>
    <p class="premark">说明：中间圆圈表示所有样品共有的基因数目；不同花瓣表示不同的样品，其中的数值表示样品的基因数目与共有基因数目的差值；括号中数值表示样品的含有基因数目和特有的基因数目；</p>';
    }

    #get decription for html
    my $i=1;
    my $j=0;
    my (@liter,@part_ori);
    if ($opt{type} eq 'soapdenovo') {
        push @liter,(1..4,6,7,28,27,29,30,8,10,13,31,32,33,34,35,36,18,11,12,37,38,39,40,45,15,16);
        @part_ori=(28,28,28,28,28,10,8,13,31,35,28,10,32,33,34,34,33,35,28,35,32,31,33,36,32,13,31,35,27,35,27,35,37,13,31,35);
    }elsif($opt{type} eq 'IDBA_UD'){
        push @liter,(1..4,6,8,10,13,31,32,33,34,35,36,18,11,12,37,38,39,40,45,15,16);
        @part_ori=(10,8,13,31,35,28,10,32,33,34,34,33,35,28,35,32,31,33,36,32,13,31,35,27,35,27,35,37,13,31,35);
    }elsif($opt{type} eq 'megahit'){
        push @liter,(1..4,6,8,10,13,31,32,33,34,35,36,18,11,12,37,38,39,40,45,15,16);
        @part_ori=(10,8,13,31,35,28,10,32,33,34,34,33,35,28,35,32,31,33,36,32,13,31,35,27,35,27,35,37,13,31,35);
    }else{die "set type for soapdenovo or IDBA_UD!\n";}
    my @part=&get_part(\@part_ori,\@liter);
    my $mulu2description=
    '<!-------------------------------------------- 概述 --------------------------------------------->'.
    '<div id="page">
        <p class="head"><a href="#home" title = "返回首页"><img class="logo" align="left" src="src/images/logo.png" /></a>
        <a name="1 概述">北京诺禾致源生物信息科技有限公司</a>
        <hr />
        </p><br />
        <h2>1 概述</h2>'.
    '<p class="paragraph">微生物群体几乎存在于这个世界每一个生态群落之中，从个体体表到肠道，从高原空气到深海海底淤泥，从冰川冻湖到火山岩浆都无处不在，并扮演着不可或缺的角色。对微生物的研究从 Antoni van Leeuwenhoek 发明显微镜开始的数百年中，主要基于纯培养的研究方式。在数以万亿计的微生物种类中，仅 0.1%~1% 的物种可培养，极大地限制了对微生物多样性资源的研究和开发。</p>
    <p class="paragraph">Metagenomics(翻译成元基因组学，或者翻译成宏基因组学)，是由 Handelman<SUP>['.$i++.']</SUP> 最先提出的一种直接对微生物群体中包含的全部基因组信息进行研究的手段。之后， Kevin<SUP>['.$i++.']</SUP> 等对 Metagenomics 进行了定义，即“绕过对微生物个体进行分离培养，应用基因组学技术对自然环境中的微生物群落进行研究”的学科。它规避了对样品中的微生物进行分离培养，提供了一种对不可分离培养的微生物进行研究的途径，更真实的反应样本中微生物组成、互作情况，同时在分子水平对其代谢通路、基因功能进行研究<SUP>['.$i++.']</SUP>。</p>
    <p class="paragraph">近年来，随着测序技术和信息技术的快速发展，利用新一代测序技术(Next Generation Sequencing)研究 Metagenomics，能快速准确的得到大量生物数据和丰富的微生物研究信息，从而成为研究微生物多样性和群落特征的重要手段<SUP>['.$i++.','.$i++.']</SUP>。如致力于研究微生物与人类疾病健康关系的人体微生物组计划(HMP, Human Microbiome Project, <a href="http://www.hmpdacc.org/">http://www.hmpdacc.org/</a> )，研究全球微生物组成和分布的全球微生物组计划(EMP, Earth Microbiome Project, <a href="http://www.earthmicrobiome.org/">http://www.earthmicrobiome.org/</a> )都主要利用高通量测序技术进行研究。</p></br></br>'.

    '<!-------------------------------------------- 建库测序流程 --------------------------------------------->'.
    '<div id="page">
        <p class="head"><a href="#home" title = "返回首页"><img class="logo" align="left" src="src/images/logo.png" /></a>
        <a name="2 项目流程">北京诺禾致源生物信息科技有限公司</a>
        <hr />
        </p><br />
        <h2>2 项目流程</h2>'.
    '<a name="2.1 建库测序流程"></a><h3>2.1 建库测序流程</h3>'.
    '<p class="paragraph">从环境（如土壤、海洋、淡水、肠道等）中采集实验样本，将原始采样样本或已提取的 DNA 样本低温运输（ 0℃ 以下）送往我公司。我公司将对接收到的样品进行样品检测。</p>
    <p class="paragraph">检测合格的 DNA 样品，进行文库构建以及文库检测，检测合格的文库将采用 Illumina HiSeq 高通量测序平台进行测序，测序得到的下机数据(Raw Data)将用于后期信息分析。为了从源头上保证测序数据的准确性、可靠性，诺禾致源对样品检测、建库、测序每一个生产步骤都严格把控，从根本上确保高质量数据的产出，具体的实验流程图如下：</p>
        <p class="center">
        <img  src="src/images/pipeline.png" width="70%" height="70%"/>
        </p>
        <p class="name">图 2.1 Metagenomics 实验流程图</p>
        <a name="2.1.1 DNA样品检测"></a><h4>2.1.1 DNA样品检测</h4>
        <p class="paragraph">诺禾致源对 DNA 样品的检测主要包括 3 种方法：</p>
        <p class="paragraph">&nbsp;&nbsp;&nbsp;&nbsp;(1) 琼脂糖凝胶电泳（AGE）分析 DNA 的纯度和完整性；</p>
        <p class="paragraph">&nbsp;&nbsp;&nbsp;&nbsp;(2) Nanodrop 检测 DNA 的纯度（OD260/280 比值）；</p>
        <p class="paragraph">&nbsp;&nbsp;&nbsp;&nbsp;(3) Qubit 对 DNA 浓度进行精确定量；</p>
        <a name="2.1.2 文库构建及库检"></a><h4>2.1.2 文库构建及库检</h4>
    <p class="paragraph">检测合格的 DNA 样品用 Covaris 超声波破碎仪随机打断成长度约为 350bp 的片段，经末端修复、加 A尾、加测序接头、纯化、PCR 扩增等步骤完成整个文库制备。</p>
    <p class="paragraph">文库构建完成后，先使用 Qubit2.0 进行初步定量，稀释文库至 2ng/ul，随后使用 Agilent 2100 对文库的 insert size 进行检测，insert size 符合预期后，使用 Q-PCR 方法对文库的有效浓度进行准确定量（文库有效浓度 ＞3nM），以保证文库质量。</p>
    <a name="2.1.3 上机测序"></a><h4>2.1.3 上机测序</h4>
    <p class="paragraph">库检合格后，把不同文库按照有效浓度及目标下机数据量的需求 pooling 后进行 Illumina HiSeq 测序。</p>'.

    '<!-------------------------------------------- 信息分析流程 --------------------------------------------->'.
    '<a name="2.2 信息分析流程"></a><h3>2.2 信息分析流程</h3>'.
    '<p class="tremark">a) 数据质控：测序得到的原始数据(Raw Data)会存在一定比例的低质量数据，为了保证后续信息分析结果的准确可靠，首先要对原始数据进行过滤处理，得到有效数据(Clean Data)；</br>
    b) Metagenome 组装：从各样品质控后的 Clean Data 出发，进行 Metagenome 组装，并将各样品未被利用上的 reads 放在一起进行混合组装，以期发现样品中的低丰度物种信息；</br>
    c) 基因预测：从单样品和混合组装后的 scaftigs 出发，采用 MetaGeneMark 进行基因预测，并将各样品和混合组装预测产生的基因放在一起，进行去冗余，构建 gene catalogue，从 gene catalogue 出发，综合各样品的 Clean Data，可获得 gene catalogue 在各样品中的丰度信息；</br>
    d) 物种注释：从 gene catalogue 出发，和 MicroNR 库进行比对，获得 Unigenes 的物种注释信息，并结合基因丰度表，获得不同分类层级的物种丰度表；</br>
    e) 功能注释：从 gene catalogue 出发，进行代谢通路(KEGG)，同源基因簇(eggNOG)，碳水化合物酶(CAZy)的功能注释和丰度分析；</br>
    f）基于物种丰度表和功能丰度表，可以进行丰度聚类分析， PCA 分析，样品聚类分析，显著差异分析，代谢通路比较分析，挖掘样品之间的物种组成和功能组成差异；同时，还可以基于标准分析结果，进行一系列高级信息分析（如 LEfSe 分析，组间群落结构差异显著性分析，CCA/RDA 分析，NMDS(Non-metric Multidimensional Scaling) 分析，病原与宿主互作数据库(PHI)注释，分泌蛋白预测，III型分泌系统效应蛋白预测，细菌致病菌毒力因子(VFDB)注释，耐药基因(ARDB)注释等，更多详细信息<a href="src/images/Advanced_Analysis.pdf">请点击</a>），并结合环境因子、病理指标或特殊表型进行深入关联研究，能够为进一步深入研究和利用样品的物种和功能提供理论依据。</p></br>
    <p class="paragraph"><font color="red">备注：</br> 
    &nbsp;&nbsp;&nbsp;&nbsp;(1) 当分组内的生物学重复数目小于3个时，诸如 PCA，LEfSe，CCA/RDA 等统计分析皆没有统计学意义，展示结果仅供参考 ;</br>
    &nbsp;&nbsp;&nbsp;&nbsp;(2) 当样品数目小于3个时，在标准分析中，无法进行 PCA 分析，聚类分析，丰度聚类 heatmap 分析。</font></p></br>
    <p class="center">
        <img  src="src/images/pipeline2.png" width="30%" height="25%"/>
        </p>
        <p class="name">图 2.2 Metagenomics 信息分析流程图</p>
        </br></br>'.

    '<!-------------------------------------------- 分析结果 --------------------------------------------->'.
    '<div id="page">
        <p class="head"><a href="#home" title = "返回首页"><img class="logo" align="left" src="src/images/logo.png" /></a>
        <a name="分析结果">北京诺禾致源生物信息科技有限公司</a>
        <hr />
        </p><br />
        <a name="3 分析结果"></a><h2>3 分析结果</h2>'.

    '<!-------------------------------------------- 数据预处理 --------------------------------------------->'.
    '<a name="3.1 测序数据预处理"></a><a href="src/images/01.CleanData--readme.pdf" title="点击查看交付目录说明文档"  data-toggle="tooltip"> <h3>3.1 测序数据预处理&nbsp;>></h3></a>'.
    '<p class="paragraph">采用 Illumina HiSeq 测序平台测序获得的原始数据(Raw Data)存在一定比例低质量数据，为了保证后续分析的结果准确可靠，需要对原始的测序数据进行预处理，获取用于后续分析的有效数据(Clean Data)。具体处理步骤如下：</p>
    <p class="tremark">1)&nbsp;去除所含低质量碱基（质量值≤38）超过一定比例（默认设为 40bp）的 reads； </br>
    2)&nbsp;去除 N 碱基达到一定比例的 reads（默认设为10bp）； </br>
    3)&nbsp;去除与 Adapter 之间 overlap 超过一定阈值（默认设为 15bp）的 reads；</br>
    4)&nbsp;如果样品存在宿主污染，需与宿主数据库进行比对，过滤掉可能来源于宿主（默认采用 SoapAligner 软件，参数设置: identity ≥ 90%, -l 30, -v 7, -M 4,-m 200,-x 400）的 reads；</br></p>
    <p class="paragraph">上述的处理步骤均是对 Read 1 和 Read 2 进行操作。测序数据预处理统计结果见表 3-1，更多详细信息请点击 <a href="src/QC_raw_report/index.html">QC_Report</a>。</p>
    <p class="name">表 3.1 数据预处理统计表</p>
        <div style="text-align:center;">
            <table id="table_clean_Data"></table>
            <div id="page_clean_Data"></div>
        </div></br>
        <p class="premark">说明：#Sample 表示样品名称；InsertSize(bp)表示使用 300bp 文库；RawData 表示下机原始数据；CleanData 表示过滤得到的有效数据；Clean_Q20，Clean_Q30 表示 CleanData 中测序错误率小于0.01(质量值大于 20)和 0.001(质量值大于 30)的碱基数目的百分比；Clean_GC(%) 表示 CleanData 中碱基的 GC 含量；Effective(%) 表示有效数据( CleanData )与原始数据( RawData )的百分比。</p></br>';
$mulu2description.=
    '<!-------------------------------------------- 组装 --------------------------------------------->'.
    '<a name="3.2 Metagenome 组装"></a><a href="src/images/02.Assembly--readme.pdf" title="点击查看交付目录说明文档"  data-toggle="tooltip"><h3>3.2 Metagenome 组装&nbsp;>></h3></a>'.
    '<p class="tremark">1）经过预处理后得到 Clean Data，使用 SOAP denovo<SUP>['.$i++.']</SUP> 组装软件进行组装分析( Assembly Analysis )；</br>
    2）对于单个样品，首先选取一个 K-mer（默认选取 55）进行组装,得到该样品的组装结果；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;组装参数<SUP>['.$i++.','.$i++.','.$i++.','.$i++.']</SUP>：-d 1, -M 3, -R, -u, -F </br>
    3）将组装得到的 Scaffolds 从 N 连接处打断，得到不含 N 的序列片段，称为 Scaftigs<SUP>['.$part[$j++].','.$i++.','.$i++.']</SUP> (i.e., continuous sequences within scaffolds)；</br>
    4）将各样品质控后的 CleanData 采用 SoapAligner 软件比对至各样品组装后的 Scaftigs 上，获取未被利用上的 PE reads；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;比对参数<SUP>['.$part[$j++].']</SUP> ：-u, -2, -m 200</br>
    5）将各样品未被利用上的 reads 放在一起，进行混合组装<SUP>['.$i++.','.$i++.','.$i++.']</SUP>，组装时，考虑到计算消耗和时间消耗，只选取一个 kmer 进行组装（默认-K 55）<SUP>['.$part[$j++].']</SUP> ，其他组装参数与单样品组装参数相同；</br>
    6）将混合组装的 Scaffolds 从 N 连接处打断，得到不含 N 的 Scaftigs 序列；</br>
    7）对于单样品和混合组装生成的 Scaftigs，过滤掉 500bp<SUP>['.$part[$j++].','.$part[$j++].','.$i++.','.$i++.','.$i++.']</SUP> 以下的片段，并进行统计分析和后续基因预测；</br></p>
    <p class="name">表 3.2 各样品组装结果 Scaftigs 基本信息统计（>=500bp）</p>
        <div style="text-align:center;">
            <table id="table_assembly"></table>
            <div id="page_assembly"></div>
        </div>
        </br>
        <p class="premark">说明：SampleID 表示样品名称（其中，NOVO_MIX 表示混合组装结果）；Total Len.（bp）表示组装得 Scaftigs 的总长；Num. 表示组装得到的 Scaftigs 总条数；Average Len.(bp) 表示 Scaftigs 的平均长度；N50，N90 表示将 Scaftigs 按照长度进行排序，然后由长到短加和，当加和值达到 Scaftigs 总长的 50%，90%时的 Scaftigs 的长度值；Max Len. 表示组装得到的最长 Scaftigs 的长度值。</p></br>
    <p class="paragraph">从组装结果出发，统计每个样品中 Scaftigs 长度的分布，并绘制成图，展示结果如下图所示：</p>'.$assembly_picts.'
    <p class="name">图 3.2 各样品的 Scaftigs 长度分布统计（>=500bp）</p>
    <p class="premark">说明：第一纵轴（Frequence(#)）表示 Scaftigs 数目；第二纵轴（Percentage（%））表示 Scaftigs 数目的百分比；横轴表示 Scaftigs 长度。</p></br>' if ($opt{type} eq 'soapdenovo');
$mulu2description.=
    '<!-------------------------------------------- 组装 --------------------------------------------->'.
    '<a name="3.2 Metagenome 组装"></a><h3>3.2 Metagenome 组装</h3>'.
    '<p class="tremark">1）经过预处理后得到 Clean Data，使用 IDBA_UD 组装软件进行组装分析( Assembly Analysis )；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;组装参数：--pre_correction </br>
    2）将组装得到的 Scaffolds 从 N 连接处打断，得到不含 N 的序列片段，称为 Scaftigs<SUP>['.$i++.','.$i++.']</SUP> (i.e., continuous sequences within scaffolds)；</br>
    3）将各样品质控后的 CleanData 采用 SoapAligner 软件比对至各样品组装后的 Scaftigs 上，获取未被利用上的 PE reads；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;比对参数 ：-u, -2, -m 200</br>
    4）将各样品未被利用上的 reads 放在一起，进行混合组装<SUP>['.$i++.','.$i++.','.$i++.']</SUP>，组装参数与单样品组装参数相同；</br>
    5）将混合组装的 Scaffolds 从 N 连接处打断，得到不含 N 的 Scaftigs 序列；</br>
    6）对于单样品和混合组装生成的 Scaftigs，过滤掉 500bp<SUP>['.$part[$j++].','.$i++.','.$i++.','.$i++.']</SUP> 以下的片段，并进行统计分析和后续基因预测；</br></p>
    <p class="name">表 3.2 各样品组装结果 Scaftigs 基本信息统计（>=500bp）</p>
        <div style="text-align:center;">
            <table id="table_assembly"></table>
            <div id="page_assembly"></div>
        </div>
        </br>
        <p class="premark">说明：SampleID 表示样品名称（其中，NOVO_MIX 表示混合组装结果）；Total Len.（bp）表示组装得 Scaftigs 的总长；Num. 表示组装得到的 Scaftigs 总条数；Average Len.(bp) 表示 Scaftigs 的平均长度；N50，N90 表示将 Scaftigs 按照长度进行排序，然后由长到短加和，当加和值达到 Scaftigs 总长的 50%，90%时的 Scaftigs 的长度值；Max Len. 表示组装得到的最长 Scaftigs 的长度值。</p></br>
    <p class="paragraph">从组装结果出发，统计每个样品中 Scaftigs 长度的分布，并绘制成图，展示结果如下图所示：</p>'.$assembly_picts.'
    <p class="name">图 3.2 各样品的 Scaftigs 长度分布统计（>=500bp）</p>
    <p class="premark">说明：第一纵轴（Frequence(#)）表示 Scaftigs 数目；第二纵轴（Percentage（%））表示 Scaftigs 数目的百分比；横轴表示 Scaftigs 长度。</p></br>' if ($opt{type} eq 'IDBA_UD');
$mulu2description.=
    '<!-------------------------------------------- 组装 --------------------------------------------->'.
    '<a name="3.2 Metagenome 组装"></a><h3>3.2 Metagenome 组装</h3>'.
    '<p class="tremark">1）经过预处理后得到 Clean Data，使用 MEGAHIT 组装软件进行组装分析( Assembly Analysis )；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;组装参数：--presets meta-large </br>
    2）将组装得到的 Scaffolds 从 N 连接处打断，得到不含 N 的序列片段，称为 Scaftigs<SUP>['.$i++.','.$i++.']</SUP> (i.e., continuous sequences within scaffolds)；</br>
    3）将各样品质控后的 CleanData 采用 SoapAligner 软件比对至各样品组装后的 Scaftigs 上，获取未被利用上的 PE reads；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;比对参数 ：-u, -2, -m 200</br>
    4）将各样品未被利用上的 reads 放在一起，进行混合组装<SUP>['.$i++.','.$i++.','.$i++.']</SUP>，组装参数与单样品组装参数相同；</br>
    5）将混合组装的 Scaffolds 从 N 连接处打断，得到不含 N 的 Scaftigs 序列；</br>
    6）对于单样品和混合组装生成的 Scaftigs，过滤掉 500bp<SUP>['.$part[$j++].','.$i++.','.$i++.','.$i++.']</SUP> 以下的片段，并进行统计分析和后续基因预测；</br></p>
    <p class="name">表 3.2 各样品组装结果 Scaftigs 基本信息统计（>=500bp）</p>
        <div style="text-align:center;">
            <table id="table_assembly"></table>
            <div id="page_assembly"></div>
        </div>
        </br>
        <p class="premark">说明：SampleID 表示样品名称（其中，NOVO_MIX 表示混合组装结果）；Total Len.（bp）表示组装得 Scaftigs 的总长；Num. 表示组装得到的 Scaftigs 总条数；Average Len.(bp) 表示 Scaftigs 的平均长度；N50，N90 表示将 Scaftigs 按照长度进行排序，然后由长到短加和，当加和值达到 Scaftigs 总长的 50%，90%时的 Scaftigs 的长度值；Max Len. 表示组装得到的最长 Scaftigs 的长度值。</p></br>
    <p class="paragraph">从组装结果出发，统计每个样品中 Scaftigs 长度的分布，并绘制成图，展示结果如下图所示：</p>'.$assembly_picts.'
    <p class="name">图 3.2 各样品的 Scaftigs 长度分布统计（>=500bp）</p>
    <p class="premark">说明：第一纵轴（Frequence(#)）表示 Scaftigs 数目；第二纵轴（Percentage（%））表示 Scaftigs 数目的百分比；横轴表示 Scaftigs 长度。</p></br>' if ($opt{type} eq 'megahit');
	
$mulu2description .=
    '<!-------------------------------------------- 基因预测 --------------------------------------------->'.
    '<a name="3.3 基因预测及丰度分析"></a><a href="src/images/03.GenePredict--readme.pdf" title="点击查看交付目录说明文档"  data-toggle="tooltip"> <h3>3.3 基因预测及丰度分析&nbsp;>></h3> </a>'.
    '<a name="3.3.1 基因预测及丰度分析基本步骤"></a><h4>3.3.1 基因预测及丰度分析基本步骤</h4>'.
    '<p class="tremark">1）从各样品及混合组装的 Scaftigs（>=500bp）出发，采用 <a href="http://topaz.gatech.edu/GeneMark/">MetaGeneMark</a><SUP>['.$part[$j++].','.$part[$j++].','.$part[$j++].','.$part[$j++].','.$i++.','.$i++.']</SUP>  进行 ORF (Open Reading Frame) 预测，并从预测结果出发，过滤掉长度小于 100nt<SUP>['.$part[$j++].','.$part[$j++].','.$part[$j++].','.$part[$j++].','.$part[$j++].']</SUP> 的信息；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;预测参数：采用默认参数进行</br>
    2）对各样品及混合组装的 ORF 预测结果，采用 <a href="http://www.bioinformatics.org/cd-hit/">CD-HIT</a><SUP>['.$i++.','.$i++.']</SUP> 软件进行去冗余，以获得非冗余的初始 gene catalogue（此处，操作上，将非冗余的连续基因编码的核酸序列称之为 genes<SUP>['.$part[$j++].']</SUP>），默认以 identity 95%, coverage 90% 进行聚类，并选取最长的序列为代表性序列；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;采用参数<SUP>['.$part[$j++].','.$part[$j++].']</SUP>：-c 0.95, -G 0, -aS 0.9, -g 1, -d 0</br>
    3）采用 <a href="http://soap.genomics.org.cn/soapaligner.html">SoapAligner</a>，将各样品的 Clean Data 比对至初始 gene catalogue，计算得到基因在各样品中比对上的 reads 数目；</br>
    &nbsp;&nbsp;&nbsp;&nbsp;比对参数<SUP>['.$part[$j++].','.$part[$j++].']</SUP>：-m 200, -x 400, identity ≥ 95%</br>
    4）过滤掉在各个样品中支持 reads 数目<=2<SUP>['.$part[$j++].','.$i++.']</SUP> 的基因，获得最终用于后续分析的 gene catalogue（Unigenes）；</br>
    5）从比对上的 reads 数目及基因长度出发，计算得到各基因在各样品中的丰度信息，计算公式<SUP>['.$part[$j++].','.$part[$j++].','.$part[$j++].','.$i++.','.$i++.','.$i++.']</SUP>如下所示：</br>
    <p class="center">
    <img  src="src/images/gene_abun.png" width="15%" height="5%"/>
    </p>
    <p class="premark">说明：r 为比对上基因的 reads 数目，L 为基因的长度</p></br>
    <p class="tremark">6）基于 gene catalogue 中各基因在各样品中的丰度信息，进行基本信息统计，core-pan 基因分析，样品间相关性分析，及基因数目韦恩图分析。</p></br>'.

    '<a name="3.3.2 gene catalogue 基本信息统计"></a><h4>3.3.2 gene catalogue 基本信息统计</h4>'.
    '<p class="name">表 3.3.2 gene catalogue 基本信息统计表</p>
        <div id="tb">'.$total_gene_table.'</div></br>
    <p class="premark">说明：ORFs NO. 表示 gene catalogue 中基因的数目；integrity:start 表示只含有起始密码子的基因数目及百分比；integrity:end 表示只含有终止密码子的基因数目及百分比；integrity:none 表示没有起始密码子也没有终止密码子的基因数目及百分比；integrity:all 表示完整基因（既有起始密码子也有终止密码子）数目的百分比；Total Len.(Mbp) 表示 gene catalogue 中基因的总长，单位是百万；Average Len. 表示 gene catalogue 中基因的平均长度；GC Percent 表示预测的 gene catalogue 中基因的整体 GC 含量值。</p>
    <p class="center">
        <a href="src/pictures/03.GeneComp/Unigenes.CDS.cdhit.fa.len.png"><img  src="src/pictures/03.GeneComp/Unigenes.CDS.cdhit.fa.len.png" width="40%" height="40%"/></a>
        </p> 
    <p class="name">图 3.3.2 gene catalogue 长度分布统计</p>
    <p class="premark">说明：第一纵轴 Frequence(#) 表示 gene catalogue 中基因的数目；第二纵轴 Percentage(%) 表示 gene catalogue 中基因数目的百分比；横轴表示 gene catalogue 中基因的长度。</p>';
    if (${$description}{'core-pan 基因分析'}) {
        $mulu2description .= '<a name="3.3.3 core-pan 基因分析"></a><h4>3.3.3 core-pan 基因分析</h4>'.$core_pan;
    }

    if( ${$description}{'组间基因数目分析'}){
        $mulu2description .= '<a name="'.${$description}{'组间基因数目分析'}.' 组间基因数目分析"></a><h4>'.${$description}{'组间基因数目分析'}.' 组间基因数目分析</h4>'.
        '<p class="paragraph">为了考察组与组间的基因数目差异情况，绘制了组间基因数目箱图，展示结果如下：</p>
        <p class="center">
            <a href="src/pictures/03.GeneComp/group.genebox.png"><img  src="src/pictures/03.GeneComp/group.genebox.png" width="40%" height="40%"/></a>
            </p> 
        <p class="name">图 '.${$description}{'组间基因数目分析'}.' 组间基因数目箱图</p>
        <p class="premark">说明：图中，横坐标为各个分组信息；纵坐标为基因数目。</p>';
    }
    if(${$description}{'基因数目韦恩图分析'}){
        $mulu2description.='<a name="'.${$description}{'基因数目韦恩图分析'}.' 基因数目韦恩图分析"></a><h4>'.${$description}{'基因数目韦恩图分析'}.' 基因数目韦恩图分析</h4>'.
    '<p class="paragraph">为了考察指定样品间的基因数目分布情况，分析不同样品之间的基因共有、特有信息，绘制了韦恩图(Venn Graph)，展示结果如下：</p>
    <p class="center">
        <a href="src/pictures/03.GeneComp/venn_display.png"><img  src="src/pictures/03.GeneComp/venn_display.png" width="40%" height="40%"/></a>
        </p> 
    <p class="name">图 '.${$description}{'基因数目韦恩图分析'}.' 样品间基因数目韦恩图</p>
    <p class="premark">说明：图中，每个圈代表一个样品；圈和圈重叠部分的数字代表样品之间共有的基因个数；没有重叠部分的数字代表样品的特有基因个数。</p>';
    }

    if(${$description}{'样品间相关性分析'}){
        $mulu2description.='<a name="'.${$description}{'样品间相关性分析'}.' 样品间相关性分析"></a><h4>'.${$description}{'样品间相关性分析'}.' 样品间相关性分析</h4>'.
    '<p class="paragraph">生物学重复是任何生物学实验所必须的，高通量测序技术也不例外。样品间基因丰度相关性是检验实验可靠性和样本选择是否合理性的重要指标。相关系数越接近1，表明样品之间基因丰度模式的相似度越高。</p>
    <p class="center">
        <a href="src/pictures/03.GeneComp/correlation.heatmap.png"><img  src="src/pictures/03.GeneComp/correlation.heatmap.png" width="40%" height="40%"/></a>
        </p> 
    <p class="name">图 '.${$description}{'样品间相关性分析'}.' 样品间相关系数热图</p>
    <p class="premark">说明：图中，不同颜色代表 spearman 相关系数的高低；相关系数与颜色间的关系见右侧图例说明；颜色越深代表样品间相关系数越大。</p>';
    }

    $mulu2description .= 
    '<!-------------------------------------------- 物种注释 --------------------------------------------->'.
    '<a name="3.4 物种注释"></a><a href="src/images/04.TaxAnnotation--readme.pdf" title="点击查看交付目录说明文档"  data-toggle="tooltip"> <h3> 3.4 物种注释&nbsp;>></h3></a>'.
    '<a name="3.4.1 物种注释基本步骤"></a><h4>3.4.1 物种注释基本步骤</h4>'.
    '<p class="tremark">1）使用DIAMOND软件<SUP>['.$i++.']</SUP>将 Unigenes 与从 <a href="http://www.ncbi.nlm.nih.gov/">NCBI</a> 的 NR(Version: 2014-10-19) 数据库中抽提出的细菌(Bacteria)、真菌(Fungi)、古菌(Archaea)和病毒(Viruses)序列进行比对（blastp，evalue ≤ 1e-5）；</br>
    2）比对结果过滤：对于每一条序列的 比对结果，选取 evalue <= 最小 evalue*10<SUP>['.$part[$j++].']</SUP> 的比对结果进行后续分析；</br>
    3）过滤后，由于每一条序列可能会有多个比对结果，得到多个不同的物种分类信息，为了保证其生物意义，采取 <a href="http://en.wikipedia.org/wiki/Lowest_common_ancestor">LCA</a> 算法(应用于 MEGAN<SUP>['.$i++.']</SUP> 软件的系统分类)，将出现第一个分支前的分类级别，作为该序列的物种注释信息；</br>
    4）从 LCA 注释结果及基因丰度表出发，获得各个样品在各个分类层级（界门纲目科属种）上的丰度信息，对于某个物种在某个样品中的丰度，等于注释为该物种的基因丰度的加和<SUP>['.$part[$j++].','.$part[$j++].','.$part[$j++].']</SUP>；</br>
    5）从 LCA 注释结果及基因丰度表出发，获得各个样品在各个分类层级（界门纲目科属种）上的基因数目表，对于某个物种在某个样品中的基因数目，等于在注释为该物种的基因中，丰度不为 0 的基因数目；</br>
    6）从各个分类层级（界门纲目科属种）上的丰度表出发，进行 Krnoa 分析，丰度柱形图展示，丰度聚类热图展示，PCA 分析，显著差异分析，差异物种丰度聚类分析及 PCA 分析。</br></p>'.

    '<a name="3.4.2 Krona 分析"></a><h4>3.4.2 Krona 分析</h4>'.
    '<p class="paragraph">为了综合而直观的展示各样品中，不同分类层级的物种相对丰度，我们采用 Krona<SUP>['.$i++.']</SUP> 对物种注释结果进行可视化展示，Krona 示例图如下所示，详细结果<a href="src/pictures/04.Taxonomy/taxonomy.krona.html">请点击</a>。</P>
    <p class="center">
            <img  src="src/images/metagenome.krona.png" width="70%" height="70%"/>
            </p><br>
    <p class="name">图 3.4.2 使用 Krona 对物种注释结果进行展示（示例图）</P>
    <p class="premark">说明：图中，圆圈从内到外依次代表不同的分类级别（界门纲目科属种）；扇形的大小代表不同物种的相对比例；更多详细的信息请参考<a href="http://sourceforge.net/p/krona/wiki/Browsing%20Krona%20chartss
        /"> KRONA 展示结果详解</a>。</P>'.

    '<a name="3.4.3 物种相对丰度柱形图分析"></a><h4>3.4.3 物种相对丰度柱形图分析</h4>'.
    '<p class="paragraph">从不同分类层级的相对丰度表出发，选取出在各样品中的最大相对丰度排名前 10 的物种，并将其余的物种设置为 Others，绘制出各样品对应的物种注释结果在不同分类层级上的相对丰度柱形图。</p>
    <p class="center">
        <a href="src/pictures/04.Taxonomy/top.pg.png"><img  src="src/pictures/04.Taxonomy/top.pg.png" width="70%" height="70%"/></a>
        </p>
    <p class="name">图 3.4.3 门水平和属水平的物种相对丰度柱形图</p>
    <p class="premark">说明：a）门水平相对丰度柱形图；b）属水平相对丰度柱形图。横轴表示样品名称；纵轴表示注释到某类型的物种的相对比例；各颜色区块对应的物种类别见右侧图例。</p>';

    if(${$description}{'基因数目及相对丰度聚类分析'}){
        $mulu2description .=
    '<a name="'.${$description}{'基因数目及相对丰度聚类分析'}.' 基因数目及相对丰度聚类分析"></a><h4>'.${$description}{'基因数目及相对丰度聚类分析'}.' 基因数目及相对丰度聚类分析</h4>'.
    '<p class="paragraph">从不同分类层级的相对丰度表出发，选取丰度排名前 35 的属及它们在每个样品中的丰度信息绘制热图，并从物种层面进行聚类，便于结果展示和信息发现，从而找出样品中聚集较多的物种，结果展示见下图：</p>
     <p class="center">
        <a href="src/pictures/04.Taxonomy/heatmap.png"><img  src="src/pictures/04.Taxonomy/heatmap.png" width="60%" height="60%"/></a>
        </p>
    <p class="name">图 '.${$description}{'基因数目及相对丰度聚类分析'}.' 属水平基因数目及丰度聚类热图</p>
    <p class="premark">说明：a) Unigenes 注释数目统计热图：横轴为样品名称；纵轴为物种信息；不同颜色代表 Unigenes 数目的高低；b) 属水平相对丰度聚类热图：横向为样品信息；纵向为物种信息；图中左侧的聚类树为物种聚类树；中间热图对应的值为每一行物种相对丰度经过标准化处理后得到的 Z 值，即一个样品在某个分类上的 Z 值为样品在该分类上的相对丰度和所有样品在该分类的平均相对丰度的差除以所有样品在该分类上的标准差所得到的值。</p>';
    }

    if(${$description}{'物种主成分分析(PCA)分析'}){
        push @liter,26;
        $mulu2description .=
    '<a name="'.${$description}{'物种主成分分析(PCA)分析'}.' 物种主成分分析(PCA)"></a><h4>'.${$description}{'物种主成分分析(PCA)分析'}.' 物种主成分分析(PCA)</h4>'.
    '<p class="paragraph">主成分分析 (PCA，Principal Component Analysis)，是一种应用方差分解，对多维数据进行降维，从而提取出数据中最主要的元素和结构的方法<SUP>['.$i++.']</SUP>。PCA 能够提取出最大程度反映样品间差异的两个坐标轴，从而将多维数据的差异反映在二维坐标图上，进而揭示复杂数据背景下的简单规律。
    基于不同分类层级的物种丰度表，我们进行了 PCA 分析，如果样品的物种组成越相似，则它们在 PCA 图中的距离越接近。</p>
    <p class="center">
        <a href="src/pictures/04.Taxonomy/PCA12_2.png"><img  src="src/pictures/04.Taxonomy/PCA12_2.png" width="40%" height="40%"/></a>
        </p>
    <p class="name">图 '.${$description}{'物种主成分分析(PCA)分析'}.' 基于门水平的物种 PCA 结果展示</p>
    <p class="premark">说明：图中，横坐标表示第一主成分，百分比则表示第一主成分对样品差异的贡献值；纵坐标表示第二主成分，百分比表示第二主成分对样品差异的贡献值；图中的每个点表示一个样品，同一个组的样品使用同一种颜色表示。</p>';
    }

    if(${$description}{'样品聚类分析taxa'}){
        $mulu2description .=
    '<a name="'.${$description}{'样品聚类分析taxa'}.' 样品聚类分析"></a><h4>'.${$description}{'样品聚类分析taxa'}.' 样品聚类分析</h4>'.
    '<p class="paragraph">为了研究不同样品的相似性，还可以通过对样品进行聚类分析，构建样品的聚类树。<a href="http://en.wikipedia.org/wiki/Bray%E2%80%93Curtis_dissimilarity">Bray-Curtis 距离</a>是系统聚类法中使用最普遍的一个距离指标，它主要用来刻画样品间的相近程度，它的大小是进行样品分类的主要依据。
    <p class="paragraph">从基因在各样品中的丰度表出发，以 Bray-Curtis 距离矩阵进行样品间聚类分析，并将聚类结果与各样品在门水平上的物种相对丰度整合进行展示。
    <p class="center">
        <a href="src/pictures/04.Taxonomy/Bar.tree.p10.png"><img  src="src/pictures/04.Taxonomy/Bar.tree.p10.png" width="50%" height="50%"/></a>
        </p>
    <p class="name">图 '.${$description}{'样品聚类分析taxa'}.' 基于 Bray-Curtis 距离的聚类树
    说明：图中，左侧是 Bray-Curtis 距离聚类树结构；右侧的是各样品在门水平上的物种相对丰度分布图。';
    }

    if(${$description}{'物种显著性差异分析'} ){
        push @liter,41;
        if($show{tax_box}){
		$mulu2description .=
    '<a name="'.${$description}{'物种显著性差异分析'}.' 物种显著性差异分析"></a><h4>'.${$description}{'物种显著性差异分析'}.' 物种显著性差异分析</h4>'.
    '<p class="paragraph">为了研究组间具有显著性差异的物种，从不同层级的物种丰度表出发，利用 Metastats<SUP>['.$i++.']</SUP> 方法对组间的物种丰度数据进行假设检验得到 p 值，通过对 p 值的校正，得到 q 值；最后根据 q 值筛选具有显著性差异的物种，并绘制差异物种在组间的丰度分布箱图。</p>
    <p class="center">
        <a href="src/pictures/04.Taxonomy/top.12.png"><img  src="src/pictures/04.Taxonomy/top.12.png" width="60%" height="60%"/></a>
        </p>
    <p class="name">图 '.${$description}{'物种显著性差异分析'}.'.1 显著差异物种的箱图展示</p>
    <p class="premark">说明：图中，横轴为样品分组；纵向为对应物种的相对丰度。横线代表具有显著性差异的两个分组，没有则表示此物种在两个分组间不存在差异。“＊”表示两组间差异显著（q value < 0.05），“＊＊”表示两组间差异极显著（q value < 0.01）。</p>';
	    }
	    if($show{tax_diff}){
		$mulu2description .=
    '<p class="paragraph">根据组间具有差异的物种进行主成分 PCA 分析和丰度聚类热图分析，展示结果如下:</p>
     <p class="center">
        <a href="src/pictures/04.Taxonomy/tax.ph.png"><img  src="src/pictures/04.Taxonomy/tax.ph.png" width="60%" height="60%"/></a>
        </p>
    <p class="name">图 '.${$description}{'物种显著性差异分析'}.'.2 基于显著性差异物种的 PCA 分析和丰度聚类热图</p>
    <p class="premark">说明：a) 为显著性差异物种的丰度聚类热图：横向为样品信息；纵向为物种注释信息；图中左侧的聚类树为物种聚类树；中间热图对应的值为每一行物种相对丰度经过标准化处理后得到的 Z 值；b) 为显著性差异物种的 PCA 图：横坐标表示第一主成分，百分比则表示第一主成分对样品差异的贡献值；纵坐标表示第二主成分，百分比表示第二主成分对样品差异的贡献值；图中的每个点表示一个样品，同一个组的样品使用同一种颜色表示。</p>';
	    }
    }
    push @liter,(21,42,43,23,44);
    $mulu2description .=
    '<!-------------------------------------------- 功能注释 --------------------------------------------->'.
    '<a name="3.5 功能注释"></a><a href="src/images/05.FunctionAnnotation--readme.pdf" title="点击查看交付目录说明文档"  data-toggle="tooltip"> <h3>3.5 功能注释&nbsp;>></h3> </a>'.
    '<p class="paragraph">目前提供注释的数据库主要有：</p>
    <p class="paragraph">&nbsp;&nbsp;&nbsp;&nbsp;Kyoto Encyclopedia of Genes and Genomes (KEGG)<SUP>['.$i++.','.$i++.']</SUP>; </p>
    <p class="paragraph">&nbsp;&nbsp;&nbsp;&nbsp;Evolutionary genealogy of genes: Non-supervised Orthologous Groups (eggNOG)<SUP>['.$i++.']</SUP>; Version：4.1；</p>
    <p class="paragraph">&nbsp;&nbsp;&nbsp;&nbsp;Carbohydrate-Active enzymes Database (CAZy)<SUP>['.$i++.']</SUP>; Version: 2014.11.25；</p>
    <p class="paragraph">KEGG 数据库于 1995 年由 Kanehisa Laboratories 推出 0.1 版，目前发展为一个综合性数据库，其中最核心的为 KEGG PATHWAY 和 KEGG ORTHOLOGY 数据库。在 KEGG ORTHOLOGY 数据库中，将行使相同功能的基因聚在一起，称为 Ortholog Groups (KO entries)，每个 KO 包含多个基因信息，并在一至多个 pathway 中发挥作用。而在 KEGG PATHWAY 数据库中，将生物代谢通路划分为 6 类，分别为：细胞过程（Cellular Processes）、环境信息处理（Environmental Information Processing）、遗传信息处理（Genetic Information Processing）、人类疾病（Human Diseases）、新陈代谢（Metabolism）、生物体系统（Organismal Systems），其中每类又被系统分类为二、三、四层。第二层目前包括有 43 种子 pathway；第三层即为其代谢通路图；第四层为每个代谢通路图的具体注释信息。</p>
    <p class="paragraph">eggNOG 数据库是利用 Smith-Waterman 比对算法对构建的基因直系同源簇 (Orthologous Groups) 进行功能注释，eggNOG V4.1 涵盖了 2,031 个物种的基因，构建了约 19 万个 Orthologous Groups。</p>
    <p class="paragraph">CAZy 数据库是研究碳水化合物酶的专业级数据库，主要涵盖 6 大功能类：糖苷水解酶（Glycoside Hydrolases ，GHs），糖基转移酶（Glycosyl Transferases，GTs），多糖裂合酶（Polysaccharide Lyases，PLs），碳水化合物酯酶（Carbohydrate Esterases，CEs），辅助氧化还原酶(Auxiliary Activities , AAs)和碳水化合物结合模块（Carbohydrate-Binding Modules， CBMs）。</p>'.

    '<a name="3.5.1 功能注释基本步骤"></a><h4>3.5.1 功能注释基本步骤</h4>'.
    '<p class="paragraph">1）使用DIAMOND软件将 Unigenes 与各功能数据库进行比对（blastp，evalue ≤ 1e-5）<SUP>['.$part[$j++].','.$part[$j++].']</SUP>；</p>
    <p class="paragraph">2）比对结果过滤：对于每一条序列的 比对结果，选取 score 最高的比对结果（one HSP > 60 bits）进行后续分析<SUP>['.$part[$j++].','.$part[$j++].','.$part[$j++].','.$i++.']</SUP>；</p>
    <p class="paragraph">3）从比对结果出发，统计不同功能层级的相对丰度（各功能层级的相对丰度等于注释为该功能层级的基因的相对丰度之和<SUP>['.$part[$j++].','.$part[$j++].','.$part[$j++].']</SUP>），其中，KEGG 数据库划分为 5 个层级，eggNOG 数据库划分为 3 个层级，CAZy 数据库划分为 3 个层级，各数据库的详细划分层级如下所示：</p>
    <div id="tb">
    <table>
    <tbody>
    <tr><th>数据库名称</th><th>划分层级</th><th>该层级的描述</th></tr>
    <tr><td>KEGG</td><td>level1</td><td>KEGG 代谢通路第一层级 6 大代谢通路；</td></tr>
    <tr><td>KEGG</td><td>level2</td><td>KEGG 代谢通路第二层级 43 种子 pathway；</td></tr>
    <tr><td>KEGG</td><td>level3</td><td>KEGG pathway id（例：ko00010）；</td></tr>
    <tr><td>KEGG</td><td>ko</td><td>KEGG ortholog group (例：K00010)；</td></tr>
    <tr><td>KEGG</td><td>ec</td><td> KEGG EC Number（例：EC 3.4.1.1）；</td></tr>
    <tr><td>eggNOG</td><td>level1</td><td>24 大功能类；</td></tr>
    <tr><td>eggNOG</td><td>level2</td><td>ortholog group description；</td></tr>
    <tr><td>eggNOG</td><td>og</td><td>ortholog group ID(例：ENOG410YU5S)；</td></tr>
    <tr><td>CAZy</td><td>level1</td><td>6 大功能类；</td></tr>
    <tr><td>CAZy</td><td>level2</td><td>CAZy family（例：GT51）；</td></tr>
    <tr><td>CAZy</td><td>level3</td><td>EC number（例：murein polymerase (EC 2.4.1.129)）；</td></tr>
    </tbody>
    </table>
    </div>
    </br>
    <p class="paragraph">4）从功能注释结果及基因丰度表出发，获得各个样品在各个分类层级上的基因数目表，对于某个功能在某个样品中的基因数目，等于在注释为该功能的基因中，丰度不为 0 的基因数目；</p>
    <p class="paragraph">5）从各个分类层级上的丰度表出发，进行注释基因数目分析，丰度柱形图展示，丰度聚类热图展示，PCA 分析，OG 物种归属分析，显著差异分析、差异功能丰度聚类分析及 PCA 分析，差异 OG 物种进化分析及代谢通路分析。</p>';

    if(${$description}{'注释基因数目分析'}){
        $mulu2description .=
    '<a name="'.${$description}{'注释基因数目分析'}.' 注释基因数目分析"></a><h4>'.${$description}{'注释基因数目分析'}.' 注释基因数目分析</h4>'.
    '<p class="paragraph">从 Unigenes 注释结果出发，绘制各个数据库的注释基因数目统计图，展示结果如下图所示：</p>'.$num_picts.'
    <p class="name">图 '.${$description}{'注释基因数目分析'}.'.1 各数据库注释基因数目统计图</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy 的 Unigenes 注释数目统计图。条形图上的数字代表注释上的 Unigenes 数目；其余一个坐标轴是各数据库中 level1 各功能类的代码，代码的解释见对应的图例说明。</p>';
    $mulu2description .= '<p class="paragraph">从不同层级的注释基因数目表出发，绘制各个数据库不同层级的注释基因数目统计热图，展示结果如下图所示：</p>'.$genenum_heatmap_picts.'
    <p class="name">图 '.${$description}{'注释基因数目分析'}.'.2 level1 基因数目统计热图</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy level1 的 Unigenes 注释数目统计热图。横轴为样品名称；纵轴为不同层级的描述；不同颜色代表 Unigenes 数目的高低。</p>' if $genenum_heatmap_picts;
    }

    $mulu2description .=
    '<a name="3.5.3 功能相对丰度柱形图分析"></a><h4>3.5.3 功能相对丰度柱形图分析</h4>'.
    '<p class="paragraph">从各数据库 level1 的相对丰度表出发，绘制出各个数据库中，各样品对应的在 level1 层级上的丰度统计图。</p>'.$rel_picts.'
    <p class="name">图 3.5.3 功能注释在 level1 上的相对丰度柱形图</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy 的结果展示。纵轴表示注释到某功能类的相对比例；横轴表示样品名称；各颜色区块对应的功能类别见右侧图例。</p>';

    if(${$description}{'功能丰度聚类分析'}){
        $mulu2description.=
    '<a name="'.${$description}{'功能丰度聚类分析'}.' 功能丰度聚类分析"></a><h4>'.${$description}{'功能丰度聚类分析'}.' 功能丰度聚类分析</h4>'.
    '<p class="paragraph">根据所有样品在各个数据库中的功能注释及丰度信息，选取丰度排名前 35 的功能及它们在每个样品中的丰度信息绘制热图，并从功能差异层面进行聚类。</p>'.$cluster_picts.'
    <p class="name">图 '.${$description}{'功能丰度聚类分析'}.' 功能丰度聚类热图</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy 的结果展示。横向为样品信息；纵向为功能注释信息；图中左侧的聚类树为功能聚类树；中间热图对应的值为每一行功能相对丰度经过标准化处理后得到的 Z 值。</p>';
    }

    if(${$description}{'功能主成分分析 (PCA)分析'}){
        $mulu2description.=
    '<a name="'.${$description}{'功能主成分分析 (PCA)分析'}.' 功能主成分分析 (PCA)"></a><h4>'.${$description}{'功能主成分分析 (PCA)分析'}.' 功能主成分分析 (PCA)</h4>'.
    '<p class="paragraph">基于不同分类层级的功能丰度表，我们进行了 PCA 分析，如果样品的功能组成越相似，则它们在 PCA 图中的距离越接近。</p>'.$pca_picts.'
    <p class="name">图 '.${$description}{'功能主成分分析 (PCA)分析'}.' 基于功能丰度的 PCA 分析结果展示</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy 的结果展示，横坐标表示第一主成分，百分比则表示第一主成分对样品差异的贡献值；纵坐标表示第二主成分，百分比表示第二主成分对样品差异的贡献值；图中的每个点表示一个样品，同一个组的样品使用同一种颜色表示。</p>';
    }

    if(${$description}{'样品聚类分析'}){
        $mulu2description.=
    '<a name="'.${$description}{'样品聚类分析'}.' 样品聚类分析"></a><h4>'.${$description}{'样品聚类分析'}.' 样品聚类分析</h4>'.
    '<p class="paragraph">为了研究不同样品的相似性，还可以通过对样品进行聚类分析，构建样品的聚类树。<a href="http://en.wikipedia.org/wiki/Bray%E2%80%93Curtis_dissimilarity">Bray-Curtis 距离</a>是系统聚类法中使用最普遍的一个距离指标，它主要用来刻画样品间的相近程度，它的大小是进行样品分类的主要依据。</p>
    <p class="paragraph">从基因在各样品中的丰度表出发，以 Bray-Curtis 距离矩阵进行样品间聚类分析，并将聚类结果与各样品在各数据库第一层级上的功能相对丰度整合展示。 </p>'.$circ_picts.'    
    <p class="name">图 '.${$description}{'样品聚类分析'}.' 基于Bray-Curtis距离的聚类树</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy 的结果展示。图中心是 Bray-Curtis 距离聚类树结构；外圈各层是各样品在第一层级上的功能相对丰度分布；各颜色区块对应的功能类别见左上角图例。</p>';
    }

    if(${$description}{'OG 物种归属分析'}){
        $mulu2description.=
    '<a name="'.${$description}{'OG 物种归属分析'}.' OG 物种归属分析"></a><h4>'.${$description}{'OG 物种归属分析'}.' OG 物种归属分析</h4>'.
    '<p class="paragraph">在 eggNOG 数据库中，每个 OG 都有其详细的物种归属，从 eggNOG 在第二层级（OG 层级）的注释结果出发，绘制了不同 OG 的物种归属分布圈图，展示结果如下，高清图片展示<a href="src/pictures/05.FunctionAnnotation/eggNOG.tax.unigene.num.svg">请点击</a>： </p>
     <p class="center">
        <img  src="src/pictures/05.FunctionAnnotation/eggNOG.tax.unigene.num.png" width="60%" height="60%"/>
        </p>
    <p class="name">图 '.${$description}{'OG 物种归属分析'}.' OG 的物种归属分析圈图</p>
    <p class="premark">说明：圆圈从内到外依次代表不同的分类级别（界门纲目科属种），真核生物、细菌和古菌用不同的颜色进行标示；每一个分支节点代表一大类物种的 OG；圆圈的大小与基因数目呈正相关，圆圈大小所对应的 Unigenes 数目见右侧图例。</p>';
    }

    if(${$description}{'功能显著性差异分析'}){
        if($show{fun_box}){
		    $mulu2description.=
    '<a name="'.${$description}{'功能显著性差异分析'}.' 功能显著性差异分析"></a><h4>'.${$description}{'功能显著性差异分析'}.' 功能显著性差异分析</h4>'.
    '<p class="paragraph">为了研究组间具有显著性差异的功能，从不同层级的功能相对丰度表出发，利用 Metastats 方法对组间的功能丰度数据进行假设检验得到 p 值，通过对 p 值的校正，得到 q 值；最后根据 q 值筛选具有显著性差异的功能，并绘制差异功能在组间的丰度分布箱图。</p>'.$metastat_picts.'
    <p class="name">图 '.${$description}{'功能显著性差异分析'}.'.1 显著性差异功能箱图展示</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy 的结果展示，图中横轴为样品分组，纵向为对应功能的相对丰度。横线代表具有显著性差异的两个分组，没有则表示此功能在两个分组间不存在差异。“＊”表示两组间差异显著（q value < 0.05），“＊＊”表示两组间差异极显著（q value < 0.01）。</p>';
	    }
	    if($show{fun_diff}){
		    $mulu2description.=
    '<p class="paragraph">根据组间具有差异的功能进行主成分 PCA 分析和丰度聚类热图分析，展示结果如下:</p>'.$meta_ph_picts.'
    <p class="name">图 '.${$description}{'功能显著性差异分析'}.'.2 基于显著性差异功能的 PCA 分析和丰度聚类热图</p>
    <p class="premark">说明：从上至下依次为 KEGG, eggNOG, CAZy 的结果展示。a) 为显著性差异功能的丰度聚类热图：横向为样品信息；纵向为功能注释信息；图中左侧的聚类树为功能聚类树；中间热图对应的值为每一行功能相对丰度经过标准化处理后得到的 Z 值；b) 为显著性差异功能的 PCA 图：横坐标表示第一主成分，百分比则表示第一主成分对样品差异的贡献值；纵坐标表示第二主成分，百分比表示第二主成分对样品差异的贡献值；图中的每个点表示一个样品，同一个组的样品使用同一种颜色表示。</p>';
	    }
    }

    if(${$description}{'差异 OG 的物种进化分析'}){
        $mulu2description.=
    '<a name="'.${$description}{'差异 OG 的物种进化分析'}.' 差异 OG 的物种进化分析"></a><h4>'.${$description}{'差异 OG 的物种进化分析'}.' 差异 OG 的物种进化分析</h4>'.
    '<p class="paragraph">为了研究 eggNOG 数据库中，显著差异的 OG（ortholog group）的物种进化历程，对每个显著差异的 OG，参考 eggNOG 中的数据，给出了其物种进化树。</p>
    <p class="paragraph"><a href="src/pictures/05.FunctionAnnotation/og.trees/og.trees.html">展示结果请点击。</a></p>'.
    '<p class="center">
            <img  src="src/images/eggnog.png" width="60%" height="60%"/>
            </p>'.
    '<p class="name">图 '.${$description}{'差异 OG 的物种进化分析'}.' OG 的物种进化树示例图</p>';
    }

    if(${$description}{'代谢通路分析'}){
        $mulu2description.=
    '<a name="'.${$description}{'代谢通路分析'}.' 代谢通路分析"></a><h4>'.${$description}{'代谢通路分析'}.' 代谢通路分析</h4>'.
    '<p class="paragraph">为了研究不同分组（不同样品）在代谢通路图中的差异，绘制了代谢通路网页版结果展示，整体网页版报告分为两部分：</p>
    <p class="paragraph">第一部分为 KEGG 9 大 pathway overview 图，图中，展示了两个分组（或两个样品）共有及特有的代谢通路信息，在代谢通路图中，节点代表各种化合物，边代表一系列的酶类反应，红色代表两个分组（或两个样品）共有的酶类反应，蓝色代表分组 A（或样品 A）独有的酶类反应，绿色代表分组 B（或样品 B）独有的酶类反应；</p>
    <p class="paragraph">第二部分为注释到的 pathway 代谢通路图，在代谢通路图中，节点代表各种化合物, 方框代表酶类信息（默认边框为黑色，背景为白色），不同颜色的方框代表注释为该酶类的不同 Unigenes 数目，黄色背景的酶类代表在分组间具有显著差异的酶类（若没有进行显著差异分析，则没有此部分信息），鼠标移动至该酶类，可显示差异酶类在不同分组间的丰度分布箱图。</p>
    <p class="paragraph"><a href="src/pictures/05.FunctionAnnotation/pathwaymaps/pathway.html">展示结果请点击。</a></p></br></br>'.
    '<p class="center">
            <img  src="src/images/mpath.png" width="60%" height="60%"/>
            </p>'.
    '<p class="name">图 '.${$description}{'代谢通路分析'}.' 多样品代谢通路比较分析示例图</p>';
    }
    return($return,$mulu2description,\@liter);
}
sub get_literature{
        my @literature= @_;
        my $get_literature;
        my %literature=(
            '1','Handelsman, J., Rondon, M. R., Brady, S. F., Clardy, J., & Goodman, R. M. (1998). Molecular biological access to the chemistry of unknown soil microbes: a new frontier for natural products. Chemistry & biology, 5(10), R245-R249.',
            '2','Chen, K., & Pachter, L. (2005). Bioinformatics for whole-genome shotgun sequencing of microbial communities. PLoS computational biology, 1(2), e24.',
            '3','Tringe, S. G., & Rubin, E. M. (2005). Metagenomics: DNA sequencing of environmental samples. Nature reviews genetics, 6(11), 805-814.',
            '4','Tringe, S. G., Von Mering, C., Kobayashi, A., Salamov, A. A., Chen, K., Chang, H. W., ... & Rubin, E. M. (2005). Comparative metagenomics of microbial communities. Science, 308(5721), 554-557.',
            '6','Raes, J., Foerstner, K. U., & Bork, P. (2007). Get the most out of your metagenome: computational analysis of environmental sequence data. Current opinion in microbiology, 10(5), 490-498.',
            '7','Luo et al.: SOAPdenovo2: an empirically improved memory-efficient short-read de novo assembler. GigaScience 2012 1:18.',
            '8','Mende D R, Waller A S, Sunagawa S, et al. Assessment of metagenomic assembly using simulated next generation sequencing data[J]. PloS one, 2012, 7(2): e31386.',
            '10','Nielsen H B, Almeida M, Juncker A S, et al. Identification and assembly of genomes and genetic elements in complex metagenomic samples without using reference genomes[J]. Nature biotechnology, 2014, 32(8): 822-828.',
            '11','Li W, Godzik A: Cd-hit: a fast program for clustering and comparing large sets of protein or nucleotide sequences. Bioinformatics 2006, 22(13):1658-1659.',
            '12','Fu L, Niu B, Zhu Z, Wu S, Li W: CD-HIT: accelerated for clustering the next-generation sequencing data. Bioinformatics 2012, 28(23):3150-3152.',
            '13','Karlsson FH, Tremaroli V, Nookaew I, Bergstrom G, Behre CJ, Fagerberg B, Nielsen J, Backhed F: Gut metagenome in European women with normal, impaired and diabetic glucose control. Nature 2013, 498(7452):99-103.',
            '15','Huson, Daniel H., et al. "Integrative analysis of environmental sequences using MEGAN4." Genome research 21.9 (2011): 1552-1560.',
            '16','Ondov B D, Bergman N H, Phillippy A M. Interactive metagenomic visualization in a Web browser[J]. BMC bioinformatics, 2011, 12(1): 385.',
            '17','Yok NG, Rosen GL: Combining gene prediction methods to improve metagenomic gene annotation. BMC Bioinformatics 2011, 12:20.',
            '18','Zhu, Wenhan, Alexandre Lomsadze, and Mark Borodovsky. "Ab initio gene identification in metagenomic sequences." Nucleic acids research 38.12 (2010): e132-e132',
            '19','Arumugayym M, Raes J, Pelletier E, et al. Enterotypes of the human gut microbiome[J]. nature, 2011, 473(7346): 174-180.',
            '20','Kanehisa M, Goto S, Kawashima S, Okuno Y, Hattori M (2004). The KEGG resource for deciphering the genome. Nucleic Acids Res 32 (Database issue): D277–80.',
            '21','Kanehisa M, Goto S, Hattori M, Aoki-Kinoshita KF, Itoh M, Kawashima S, et al. (2006). From genomics to chemical genomics: new developments in KEGG. Nucleic Acids Res 34(Database issue): D354–7.',
            '22','Powell S, Forslund K, Szklarczyk D, et al (2014). eggNOG v4.0: nested orthology inference across 3686 organisms. Nucleic Acids Res 42 (Database issue): D231–239.',
            '23','Cantarel BL, Coutinho PM, Rancurel C, Bernard T, Lombard V, Henrissat B (2009) .The Carbohydrate-Active EnZymes database (CAZy): an expert resource for Glycogenomics. Nucleic Acids Res 37:D233-238.',
            '24','Letunic I, Yamada T, Kanehisa M, et al. iPath: interactive exploration of biochemical pathways and networks[J]. Trends in biochemical sciences, 2008, 33(3): 101-103.',
            '25','Yamada T, Letunic I, Okuda S, et al. iPath2. 0: interactive pathway explorer[J]. Nucleic acids research, 2011, 39(suppl 2): W412-W415.',
            '26','Avershina, Ekaterina, Trine Frisli, and Knut Rudi. De novo Semi-alignment of 16S rRNA Gene Sequences for Deep Phylogenetic Characterization of Next Generation Sequencing Data. Microbes and Environments 28.2 (2013): 211-216.',
            '27','Feng Q, Liang S, Jia H, et al. Gut microbiome development along the colorectal adenoma–carcinoma sequence[J]. Nature communications, 2015, 6.',
            '28','Qin N, Yang F, Li A, et al. Alterations of the human gut microbiome in liver cirrhosis[J]. Nature, 2014.',
            '29','Scher J U, Sczesnak A, Longman R S, et al. Expansion of intestinal Prevotella copri correlates with enhanced susceptibility to arthritis[J]. Elife, 2013, 2: e01202.',
            '30','Brum J R, Ignacio-Espinoza J C, Roux S, et al. Patterns and ecological drivers of ocean viral communities[J]. Science, 2015, 348(6237): 1261498.',           
            '31','Karlsson F H, Fåk F, Nookaew I, et al. Symptomatic atherosclerosis is associated with an altered gut metagenome[J]. Nature communications, 2012, 3: 1245.',
            '32','Qin J, Li R, Raes J, et al. A human gut microbial gene catalogue established by metagenomic sequencing[J]. nature, 2010, 464(7285): 59-65.',
            '33','Zeller G, Tap J, Voigt A Y, et al. Potential of fecal microbiota for early‐stage detection of colorectal cancer[J]. Molecular systems biology, 2014, 10(11): 766.',
            '34','Sunagawa S, Coelho L P, Chaffron S, et al. Structure and function of the global ocean microbiome[J]. Science, 2015, 348(6237): 1261359.',
            '35','Li J, Jia H, Cai X, et al. An integrated catalog of reference genes in the human gut microbiome[J]. Nature biotechnology, 2014, 32(8): 834-841.',
            '36','Oh J, Byrd A L, Deming C, et al. Biogeography and individuality shape function in the human skin metagenome[J]. Nature, 2014, 514(7520): 59-64.',
            '37','Qin J, Li Y, Cai Z, et al. A metagenome-wide association study of gut microbiota in type 2 diabetes[J]. Nature, 2012, 490(7418): 55-60.',
            '38','Villar E, Farrant G K, Follows M, et al. Environmental characteristics of Agulhas rings affect interocean plankton transport[J]. Science, 2015, 348(6237): 1261447.',
            '39','Cotillard A, Kennedy S P, Kong L C, et al. Dietary intervention impact on gut microbial gene richness[J]. Nature, 2013, 500(7464): 585-588.',
            '40','Le Chatelier E, Nielsen T, Qin J, et al. Richness of human gut microbiome correlates with metabolic markers[J]. Nature, 2013, 500(7464): 541-546.',
            '41','White J R, Nagarajan N, Pop M. Statistical methods for detecting differentially abundant features in clinical metagenomic samples[J]. PLoS Comput Biol, 2009, 5(4): e1000352.',
            '42','Kanehisa, M., Goto, S., Sato, Y., Kawashima, M., Furumichi, M., and Tanabe, M.; Data, information, knowledge and principle: back to metabolism in KEGG. Nucleic Acids Res. 42, D199–D205 (2014).',
            '43','Powell S, Forslund K, Szklarczyk D, et al. eggNOG v4. 0: nested orthology inference across 3686 organisms[J]. Nucleic acids research, 2013: gkt1253.',
            '44','Bäckhed F, Roswall J, Peng Y, et al. Dynamics and Stabilization of the Human Gut Microbiome during the First Year of Life[J]. Cell host & microbe, 2015, 17(5): 690-703.',
            '45','Buchfink B, Xie C, Huson DH. Fast and sensitive protein alignment using DIAMOND. Nat Methods 2015;12:59-60.',
        );
        my $num;
        foreach my $m (@literature){
                $num++;
                $get_literature .= "[$num]  $literature{$m}<br />\n";
        }
        return $get_literature;
}

sub get_part{
    my($part,$liter)=@_;
    my $l=1;
    my %liter;
    foreach my $li (@{$liter}){
        $liter{$li}=$l;
        $l++;
    }
    my@part;
    foreach my $pa (@{$part}){
        push @part,$liter{$pa};
    }
    return @part;
}

sub digitize() {
    for (@_){
    $_ =~ s/(?<=^\d)(?=(\d\d\d)+$)    #处理不含小数点的情况^M
            |
            (?<=^\d\d)(?=(\d\d\d)+$)  #处理不含小数点的情况^M
            |
            (?<=\d)(?=(\d\d\d)+\.)    #处理整数部分^M
            |
            (?<=\.\d\d\d)(?!$)        #处理小数点后面第一次千分位^M
            |
            (?<=\G\d\d\d)(?!\.|$)     #处理小数点后第一个千分位以后的内容，或者不含小数点的情况^M
            /,/gx;
#    return $_;
    }
}

sub get_table_descri{
    my($table_array,$table_hash,$head,$description,$brief,$brief_catalog)=@_;
    my $return="
      <table>
        <tr>
          <td>
            <a name=\"$brief\"></a>
            <a href=\"report.detail.html#$brief_catalog\" target=\"_blank\"> <h2>$brief</h2></a>
            <div style='width:500px;'>";
    $return .= "<p class=\"pra\">$head</p>";
    my $mid  = &get_description($description);
    $return .= $mid;
    $return .= "\n</td>
          <td rowspan='3' style='padding-left:25px;'></td>
          <td rowspan='3'>
            <h3>结果统计</h3>
            <div class='metagenome_info' style='width: 320px;'>
              <ul style='margin: 0; padding: 0;'>";
    $return .= &get_table($table_array,$table_hash);
    $return .= "  
              </ul>
            </div>
          </td>  
        </tr>
      </table>";
    return$return;
}

sub get_description{
    my($des,)=@_;
    my $get_description=join("</p>\n<p class=\"pra\">",(split/\n/,$des));
    $get_description = "<p class=\"pra\">$get_description</p>";
    return$get_description;
}

sub get_table{
    my($table_array,$table_hash)=@_;
    my $get_table;
    foreach my $i (0..$#{$table_array}){
        if ($i%2 == 0 ) {
            $get_table .= " <li class='even'>";
        }else{$get_table .= "<li class='odd'>";}
        my $mid=${$table_array}[$i];
        $mid=~s/scaftigs$//;
        $get_table .= "
        <label style='text-align: left;white-space:nowrap;'>$mid:</label>
        <span style='width: 200px'>${$table_hash}{${$table_array}[$i]}</span>
        </li>
        ";
    }
    return $get_table;
}

sub get_index {
    my($report,$stat_info,$index_file,$dir)=@_;
    ##get stat info
    my %qc_stat;
    my %ass_stat;
    my %mix_stat;
    my %gene_stat;
    my %tax_stat;
    my %fun_stat;

    my @qc_stat;
    my @ass_stat;
    my @mix_stat;
    my @gene_stat;
    my @tax_stat;
    my @fun_stat;

    open IN,"$stat_info";
    $/="\n///";
    ####qc
    my $qc_block = <IN>;
    chomp $qc_block;
    my @qc_tmp=split /\n/,$qc_block;
    shift@qc_tmp;
    foreach my $qc_tmp (@qc_tmp){
        my @array_qc= split /\t/ ,$qc_tmp;
        $qc_stat{$array_qc[0]}=$array_qc[1];
        push @qc_stat,$array_qc[0];
    } 
    ###ass
    my $ass_block =<IN>;
    chomp $ass_block;
    my @ass_tmp=split /\n/,$ass_block;
    shift@ass_tmp;
    my $ass=0;
    foreach my $ass_tmp (@ass_tmp){
        my @array_ass=split /\t/,$ass_tmp;
        $array_ass[0].="scaftigs" if $ass > 6;
        $ass_stat{$array_ass[0]}=$array_ass[1];
        push @ass_stat,$array_ass[0];
        $ass++;
    }

    ###gene
    my $gene_block =<IN>;
    chomp $gene_block;
    my @gene_tmp=split /\n/,$gene_block;
    shift@gene_tmp;
    foreach my $gene_tmp (@gene_tmp){
        my @array_gene=split /\t/,$gene_tmp;
        if ($array_gene[0] eq 'Complete ORFs' && $array_gene[1]=~/(.*)\((.*\%)\)/) {
            my $num=$1;
            my $precent=$2;
            $gene_stat{'Complete ORFs number'}=$num;
            $gene_stat{'Complete ORFs precent'}=$precent;
            push @gene_stat,'Complete ORFs number';
            push @gene_stat,'Complete ORFs precent';
        }else{
            $gene_stat{$array_gene[0]}=$array_gene[1];
            push @gene_stat,$array_gene[0];
        }
    }
    ###tax
    my $tax_block =<IN>;
    chomp $tax_block;
    my @tax_tmp=split /\n/,$tax_block;
    shift@tax_tmp;
    my @diff_tax_detail;
    foreach my $tax_tmp (@tax_tmp){
        my @array_tax=split /\t/,$tax_tmp;
        if ($array_tax[0] eq 'Assigned Phyla(top 5)' || $array_tax[0] eq 'Sign_diff Phyla(top 5)') {
            my @taxes=@array_tax[1..$#array_tax];
            my @join_taxes;
            if ($#taxes <= 2) {
                @join_taxes=@taxes;
            }else{
                @join_taxes = @taxes[0..2];
            }
            $tax_stat{$array_tax[0]}=join(", ",@join_taxes);
            if ($taxes[0] && $taxes[1] &&  $array_tax[0] eq 'Sign_diff Phyla(top 5)') {
                $taxes[0]=~s/;/_/g;
                $taxes[1]=~s/;/_/g;
                push @diff_tax_detail,$taxes[0];
                push @diff_tax_detail,$taxes[1];
            }
        }else{
            $tax_stat{$array_tax[0]}=$array_tax[1];
            push @tax_stat,$array_tax[0];
        }
    }
    if ($diff_tax_detail[0] && $diff_tax_detail[1]) {
        `$combine  $dir/04.TaxAnnotation/MicroNR/MicroNR_stat/MetaStats/phylum/boxplot/figures/$diff_tax_detail[0].png $dir/04.TaxAnnotation/MicroNR/MicroNR_stat/MetaStats/phylum/boxplot/figures/$diff_tax_detail[1].png -ftext 'a,b' > $report/src/pictures/04.Taxonomy/meta.com.svg`;
        `$convert $report/src/pictures/04.Taxonomy/meta.com.svg $report/src/pictures/04.Taxonomy/`;
    }
    if(-s "$dir/04.TaxAnnotation/MicroNR/MicroNR_stat/MetaStats/phylum/cluster.phylum.diff.png" && -s "$dir/04.TaxAnnotation/MicroNR/MicroNR_stat/MetaStats/phylum/PCA/PCA12_2.png"){
        `$combine  $dir/04.TaxAnnotation/MicroNR/MicroNR_stat/MetaStats/phylum/cluster.phylum.diff.png $dir/04.TaxAnnotation/MicroNR/MicroNR_stat/MetaStats/phylum/PCA/PCA12_2.png -ftext 'c,d' > $report/src/pictures/04.Taxonomy/meta.com2.svg`;
        `$convert $report/src/pictures/04.Taxonomy/meta.com2.svg $report/src/pictures/04.Taxonomy/`;
    }

    ###fun
    my $fun_block =<IN>;
    chomp $fun_block;
    my @fun_tmp=split /\n/,$fun_block;
    shift@fun_tmp;
    foreach my $fun_tmp (@fun_tmp){
        my @array_fun=split /\t/,$fun_tmp;
        if($array_fun[0] eq 'Annotated on KO'){
          if ($array_fun[1]=~/(.*)\/(.*)/) {
            $fun_stat{'Annotated on KO'}=$1;
            $fun_stat{'Annotated on KO number'}=$2;
            push @fun_stat,'Annotated on KO';
            push @fun_stat,'Annotated on KO number';
          }
        }else{
          $fun_stat{$array_fun[0]}=$array_fun[1];
          push @fun_stat,$array_fun[0];
        }
    }
    $/="\n";
    close IN ;

    #00.totalstat
    my $total_stat="本研究采用 Illumina HiSeq 测序平台测序，共获得 $qc_stat{'Total Raw Data'} 的原始数据(Raw Data)（平均数据量为 $qc_stat{'Average Raw Data'}），经过质控得到 $qc_stat{'Total Clean Data'} 的有效数据(Clean Data)（平均数据量为 $qc_stat{'Average Clean Data'}），经过单样品组装及混合组装后，共得到 $ass_stat{'Total length (nt)scaftigs'} 的 Scaftigs。对各样品及混合组装的结果，采用 MetaGeneMark 软件进行基因预测，共得到 $gene_stat{'Total ORFs'} 个开放阅读框（ORFs）（平均为 $gene_stat{'Average ORFs'}），经过去冗余后，共获得 $gene_stat{'Gene catalogue'} 个ORFs，总长为 $gene_stat{'Total length (Mbp)'}，其中完整基因的个数为 $gene_stat{'Complete ORFs number'}，所占比例为 $gene_stat{'Complete ORFs precent'}。拿去冗余后的基因，与 MicroNR 库进行 blastp 比对，运用 LCA 算法进行物种注释，注释到属和门的比例分别为 $tax_stat{'Annotated on Genus level'} , $tax_stat{'Annotated on Phylum level'}。使用 DIAMOND 软件进行基因功能注释（e-value ≤10−5），有 $fun_stat{'Annotated on CAZy'} 个 ORFs 比对到 CAZy 数据库，$fun_stat{'Annotated on KEGG'} 个 ORFs 比对到 KEGG 数据库，$fun_stat{'Annotated on eggNOG'} 个 ORFs 比对到 eggNOG 数据库。";

    #01.CleanData
    my $CleanData_stat;
    my $CleanData_stat="质控结果概述：总共测序数据量为 $qc_stat{'Total Raw Data'}，平均测序数据量为 $qc_stat{'Average Raw Data'}，质控后总体数据量及平均数据量分别为 $qc_stat{'Total Clean Data'}，$qc_stat{'Average Clean Data'}，质控的有效数据率为 $qc_stat{'Effective percent'}。";
    $CleanData_stat.="去宿主后的总体数据量为 $qc_stat{'Total Nohost Data'}，平均数据量为 $qc_stat{'Average Nohost Data'}，去除宿主的有效数据率为 $qc_stat{'Effective rate'}。" if $opt{host};

    my $clean_description="数据预处理的具体处理步骤如下：
    1) 去除所含低质量碱基（质量值≤38）超过一定比例（默认设为 40bp）的 reads； 
    2) 去除 N 碱基达到一定比例的 reads（默认设为10bp）； 
    3) 去除与 Adapter 之间 overlap 超过一定阈值（默认设为 15bp）的 reads；
    4) 如果样品存在宿主污染，需与宿主数据库进行比对，过滤掉可能来源于宿主的 reads；";
    my $CleanData_dis_table=&get_table_descri(\@qc_stat,\%qc_stat,$CleanData_stat,$clean_description,"测序数据预处理","3.1 测序数据预处理");

    #02.assembly
    my $assembly_stat="组装结果概述：共组装得到 $ass_stat{'Total length (nt)'} 的 Scaffolds ，平均长度为 $ass_stat{'Average length (nt)'}，最大长度为 $ass_stat{'Longest length (nt)'}，N50 为 $ass_stat{'N50 length (nt)'}，N90 为 $ass_stat{'N90 length (nt)'}；从 N 处打断 Scaffolds，生成 Scaftigs, 共得到 $ass_stat{'Total length (nt)scaftigs'} 的 Scaftigs，Scaftigs 平均长度为 $ass_stat{'Average length (nt)scaftigs'}，N50 为 $ass_stat{'N50 length (nt)scaftigs'}，N90 为 $ass_stat{'N90 length (nt)scaftigs'}。";
    my $ass_description;
    if ($opt{type} eq 'soapdenovo') {
     $ass_description="Metagenome 组装的具体处理步骤如下：
     1）经过预处理后得到 Clean Data，使用 SOAP denovo 组装软件进行组装；
    2）对于单个样品，首先选取一个 K-mer（默认选取55）进行组装，得到该样品的组装结果；
    3）将组装得到的 Scaffolds 从 N 连接处打断，得到不含 N 的序列片段，称为 Scaftigs (i.e., continuous sequences within scaffolds)；
    4）将各样品质控后的 CleanData 采用 SoapAligner 软件比对至各样品组装后的 Scaftigs 上，获取未被利用上的 PE reads；
    5）将各样品未被利用上的 reads 放在一起，进行混合组装，组装时，考虑到计算消耗和时间消耗，只选取一个 kmer 进行组装（默认-K 55），其他组装参数与单样品组装参数相同；
    6）将混合组装的 Scaffolds 从 N 连接处打断，得到不含 N 的 Scaftigs 序列；
    7）对于单样品和混合组装生成的 Scaftigs，过滤掉 500bp 以下的片段，并进行统计分析和后续基因预测；";
    }elsif($opt{type} eq 'IDBA_UD'){
     $ass_description="Metagenome 组装的具体处理步骤如下：
    1）经过预处理后得到 Clean Data，使用 IDBA_UD 组装软件进行组装；
    2）将组装得到的 Scaffolds 从 N 连接处打断，得到不含 N 的序列片段，称为 Scaftigs (i.e., continuous sequences within scaffolds)；
    3）将各样品质控后的 CleanData 采用 SoapAligner 软件比对至各样品组装后的 Scaftigs 上，获取未被利用上的 PE reads；
    4）将各样品未被利用上的 reads 放在一起，进行混合组装；
    5）将混合组装的 Scaffolds 从 N 连接处打断，得到不含 N 的 Scaftigs 序列；
    6）对于单样品和混合组装生成的 Scaftigs，过滤掉 500bp 以下的片段，并进行统计分析和后续基因预测；";
    }elsif($opt{type} eq 'megahit'){
	$ass_description="Metagenome 组装的具体处理步骤如下：
    1）经过预处理后得到 Clean Data，使用 MEGAHIT 组装软件进行组装；
    2）将组装得到的 Scaffolds 从 N 连接处打断，得到不含 N 的序列片段，称为 Scaftigs (i.e., continuous sequences within scaffolds)；
    3）将各样品质控后的 CleanData 采用 SoapAligner 软件比对至各样品组装后的 Scaftigs 上，获取未被利用上的 PE reads；
    4）将各样品未被利用上的 reads 放在一起，进行混合组装；
    5）将混合组装的 Scaffolds 从 N 连接处打断，得到不含 N 的 Scaftigs 序列；
    6）对于单样品和混合组装生成的 Scaftigs，过滤掉 500bp 以下的片段，并进行统计分析和后续基因预测；";
	}
    my $ass_dis_table=&get_table_descri(\@ass_stat,\%ass_stat,$assembly_stat,$ass_description,"Metagenome 组装","3.2 Metagenome 组装");


    #03.gene.predict
    my $gene_predict_stat="基因预测结果概述：一共预测得到 $gene_stat{'Total ORFs'} 条 ORFs，平均每个样品 $gene_stat{'Average ORFs'} 条 ORFs；经去冗余后，得到 $gene_stat{'Gene catalogue'} 条 ORFs，去冗余后的 ORFs 总长为 $gene_stat{'Total length (Mbp)'} Mbp，平均长度 $gene_stat{'Average length (bp)'} bp，GC 含量为 $gene_stat{'GC percent'}，其中，完整基因有 $gene_stat{'Complete ORFs number'} 个，占所有非冗余基因总数的 $gene_stat{'Complete ORFs precent'}。
    ";
    my $gene_predict_description="基因预测基本步骤：
    1）从各样品及混合组装的 Scaftigs（>=500bp）出发，采用 MetaGeneMark 进行 ORF (Open Reading Frame) 预测及过滤；
    2）对各样品及混合组装的 ORF 预测结果，采用 CD-HIT 软件进行去冗余；
    3）将各样品的 Clean Data 比对至去冗余后的代表性基因上，计算得到基因在各样品中比对上的 reads 数目；
    4）过滤掉在各个样品中，不存在支持 reads 数目>2 的基因，获得最终用于后续分析的 gene catalogue（Unigenes）；
    5）从比对上的 reads 数目及基因长度出发，计算得到各基因在各样品中的丰度信息；
    6）基于 gene catalogue 中各基因在各样品中的丰度信息，进行基本信息统计，core-pan 基因分析，样品间相关性分析，及基因数目韦恩图分析。";
    my $gene_predict_dis_table=&get_table_descri(\@gene_stat,\%gene_stat,$gene_predict_stat,$gene_predict_description,"基因预测及丰度分析","3.3 基因预测及丰度分析");

    #04.taxonomy.annotation
    my $taxonomy_stat="物种注释结果概述：原始去冗余后的预测基因共有 $tax_stat{'Gene catalogue'} 条，其中，能够注释到 NR 数据库的 ORFs 数目为 $tax_stat{'Annotated on NR'}，在能够注释到 NR 数据库的 ORFs 中，注释到界水平的比例为 $tax_stat{'Annotated on Kingdom level'}，门水平的比例为 $tax_stat{'Annotated on Phylum level'}，纲水平的比例为 $tax_stat{'Annotated on Class level'}，目水平的比例为 $tax_stat{'Annotated on Order level'}，科水平的比例为 $tax_stat{'Annotated on Family level'}，属水平的比例为 $tax_stat{'Annotated on Genus level'}，种水平的比例为 $tax_stat{'Annotated on Species level'}。其中占主导地位的门主要包括 $tax_stat{'Assigned Phyla(top 5)'} 等。";
    $taxonomy_stat .="组间具有显著性差异的门主要有 $tax_stat{'Sign_diff Phyla(top 5)'} 等。" if $tax_stat{'Sign_diff Phyla(top 5)'};
    my $taxonomy_description="物种注释基本步骤：
    1）使用DIAMOND软件将 Unigenes 与从 NCBI 的 NR(Version: 2014-10-19) 数据库中抽提出的细菌(Bacteria)、真菌(Fungi)、古菌(Archaea)和病毒(Viruses)序列进行比对（blastp，evalue ≤ 1e-5）；
    2）比对结果过滤：对于每一条序列的比对结果，选取 evalue <= 最小 evalue*10 的比对结果进行后续分析；
    3）过滤后，采取 LCA 算法(应用于 MEGAN 软件的系统分类)，将出现第一个分支前的分类级别，作为各序列的物种注释信息；
    4）从 LCA 注释结果及基因丰度表出发，获得各个样品在各个分类层级（界门纲目科属种）上的丰度信息和基因数目信息；
    5）从各个分类层级（界门纲目科属种）上的丰度表出发，进行 Krnoa 分析，丰度柱形图展示，丰度聚类热图展示，PCA 分析，显著差异分析，差异物种丰度聚类分析及 PCA 分析。";
    my $taxonomy_dis_table=&get_table_descri(\@tax_stat,\%tax_stat,$taxonomy_stat,$taxonomy_description,"物种注释","3.4 物种注释");

    #05.function.annotation
    my $function_stat="功能注释结果概述：原始去冗余后的预测基因共有 $fun_stat{'Gene catalogue'} 个，有 $fun_stat{'Annotated on KEGG'} 个基因能够比对上 KEGG 数据库，其中，有 $fun_stat{'Annotated on KO'} 个基因能够比对上数据库中的 $fun_stat{'Annotated on KO number'} 个 KEGG ortholog group （KO）；有 $fun_stat{'Annotated on eggNOG'} 个基因能够比对上 eggNOG 数据库；有 $fun_stat{'Annotated on CAZy'} 个基因能够比对上 CAZy 数据库。";
    my $function_description="功能注释基本步骤：
    1）使用DIAMOND软件将 Unigenes 与各功能数据库进行比对（blastp，evalue ≤ 1e-5）；
    2）比对结果过滤：对于每一条序列的比对结果，选取 score 最高的比对结果（one HSP > 60 bits）进行后续分析；
    3）从比对结果出发，统计不同功能层级的相对丰度和基因数目信息；
    4）从各个分类层级上的丰度表出发，进行注释基因数目分析，丰度柱形图展示，丰度聚类热图展示，PCA 分析，OG 物种归属分析，显著差异分析、差异功能丰度聚类分析及 PCA 分析，差异 OG 物种进化分析及代谢通路分析。";
    my $function_dis_table=&get_table_descri(\@fun_stat,\%fun_stat,$function_stat,$function_description,"功能注释","3.5 功能注释");
    ###end for get png, json and head

    ##################main script##################
    open(OUT,">$index_file");

    print OUT << "OUT"
    <!DOCTYPE HTML>
    <html>
      <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>项目概述</title>   
        <link rel="stylesheet" type="text/css" href="src/css/novo.css" > 
      </head>
    <body onload="initialize_all();">

       <div id="topbar">
        <table style="width: 100%; border-spacing: 0px;">
          <tr>
        <td style='width: 100%; padding: 0px;'>
          
             <div style='height: 60px;'></div>
          
        </td>
          </tr>
        </table>
      </div>


    <div id="content_frame">
        <div id="page_title">诺禾致源 Metagenome 分析结题报告</div>
        <div id="content">
          <p>
            <div style='width: 700px'>
              <div style='float: left'>
                <table>
                  <tr>
                    <td><b>合同编号</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$id</td>
                  </tr>
                  <tr>
                    <td><b>合同名称</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pro</td>
                  </tr>
                  <tr>
                    <td><b>报告时间</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$date</td>
                  </tr>
                  <tr>
                    <td><b>报告编号</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$report_id</td>
                  </tr>
                  <tr>
                    <td><b>联系人</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${$contact{$opt{contact}}}[0]</td>
                  </tr>
                  <tr><td><b>邮箱</b></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="mailto:${$contact{$opt{contact}}}[2]">${$contact{$opt{contact}}}[2]</a></td></tr>
                  <tr>
                    <td><b>电话</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${$contact{$opt{contact}}}[1]</td>
                  </tr>
                  <tr>
                    <td><b>结题报告详细版</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="report.detail.html">请点击</a></td>
                  </tr>
                  <tr>
                    <td><b>公司主页</b></td>
                    <td><a href='http://www.novogene.cn'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.novogene.cn</a></td>
                  </tr>
				  <tr>
                    <td><b>结题时间</b></td>
                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$date</td>
                  </tr>
                </table>
              </div>
            </div>
          </p>
          <div style='clear: both; height: 10px'></div>
          <table>
            <tr><td>
             <h2>Metagenomics 概述</h2>
              <div style='width:500px;'>
                <p class="pra">微生物群体几乎存在于这个世界每一个生态群落之中，从个体体表到肠道，从高原空气到深海海底淤泥，从冰川冻湖到火山岩浆都无处不在，并扮演着不可或缺的角色。对微生物的研究从 Antoni van Leeuwenhoek 发明显微镜开始的数百年中，主要基于纯培养的研究方式。在数以万亿计的微生物种类中，仅 0.1%~1% 的物种可培养，极大地限制了对微生物多样性资源的研究和开发。</p>
                <p class="pra">Metagenomics(翻译成元基因组学，或者翻译成宏基因组学)是由 Handelman 最先提出的一种直接对微生物群体中包含的全部基因组信息进行研究的手段。之后， Kevin等对 Metagenomics 进行了定义，即“绕过对微生物个体进行分离培养，应用基因组学技术对自然环境中的微生物群落进行研究”的学科。它规避了对样品中的微生物进行分离培养，提供了对无法分离培养的微生物进行研究的途径，避免了实验过程中由环境改变引起的微生物序列变化所带来的偏差。</p>
                <p class="pra">近年来，随着测序技术和信息技术的快速发展，利用新一代测序技术(Next Generation Sequencing)研究 Metagenomics，能快速准确的得到大量生物数据和丰富的微生物研究信息，从而成为研究微生物多样性和群落特征的重要手段。如致力于研究微生物与人类疾病健康关系的人体微生物组计划(HMP, Human Microbiome Project, http://www.hmpdacc.org/ )，研究全球微生物组成和分布的全球微生物组计划(EMP, Earth Microbiome Project, http://www.earthmicrobiome.org/ )都主要利用高通量测序技术进行研究。</p>
              </div>
            </td>
        
            <td rowspan='4' style='padding-left:25px;'></td>
            <td  <td rowspan='4'><h2>目录</h2>
              <div style='border:2px solid #AAAAAA;padding:40px;background-color:#EEEEEE;'>
                <li>Metagenomics 概述</li>
                <li style='padding-top:15px;'>分析流程</li>
                <ul style='margin:0;'>
                  <li style='padding-top:5px'><a href='report.detail.html#2.1 建库测序流程'>建库测序流程</a></li>
                  <li style='padding-top:5px'><a href='report.detail.html#2.2 信息分析流程'>信息分析流程</a></li>
                </ul>

                <li style='padding-top:15px;'>分析结果</li>
                <ul style='margin:0;'>
                  <li style='padding-top:5px'><a href='#分析结果概述'>分析结果概述</a></li>
                  <li style='padding-top:5px'><a href='#测序数据预处理'>测序数据预处理</a></li>
                  <li style='padding-top:5px'><a href='#Metagenome 组装'>Metagenome 组装</a></li>
                  <li style='padding-top:5px'><a href='#基因预测及丰度分析'>基因预测及丰度分析</a></li>
                  <li style='padding-top:5px'><a href='#物种注释'>物种注释</a></li>
                  <li style='padding-top:5px'><a href='#功能注释'>功能注释</a></li>
                </ul>
              </div>
            </td></tr>
          </table>
          <br>
          
          <!---------------分析结果概述-------------->
          <table>
            <tr>
            <a name="分析结果概述"></a> 
            <a href="report.detail.html#3 分析结果" target="_blank"> <h2>分析结果概述</h2></a>
            </tr>
            <tr>
              <td>
                <div style='width:900px;'>
            <p class="pra">
OUT
;
     print OUT "$total_stat";
     print OUT << "OUT"
                </p>
                </div>
              </td>
            </tr>
          </table>

    <!---------------测序数据预处理-------------->
OUT
;

    print OUT 
    "
    $CleanData_dis_table
    <!---------------Metagenome 组装-------------->
    $ass_dis_table";

    print OUT 
    "
    <!---------------基因预测-------------->
    $gene_predict_dis_table
    ";
    if (-s "$report/src/pictures/03.GeneComp/combine.gene.png" && -s "$report/src/pictures/03.GeneComp/correlation.heatmap.png"){
          print OUT   <<"OUT"  
          <table>
            <tr>
              <td>
                <div style='width:900px;'>
                <p class="pra">从基因在各样品中的丰度表出发，可以获得各样品的基因数目信息，通过随机抽取不同数目的样品，可以获得不同数目样品组合间的基因数目，由此我们构建和绘制了 Core 和 Pan 基因的稀释曲线，曲线越接近平缓，表示随着测序样品数目的增加，基因数目逐渐趋于稳定。</p>
                <p class="pra">生物学重复是任何生物学实验所必须的，高通量测序技术也不例外。样品间基因丰度相关性是检验实验可靠性和样本选择是否合理性的重要指标。相关系数越接近1，表明样品之间基因丰度模式的相似度越高。</p>
                 <div style="text-align:center;">
                 <p class="center">
                 <a href="src/pictures/03.GeneComp/combine.gene.png"><img  src="src/pictures/03.GeneComp/combine.gene.png" width="85%" height="85%"/></a>
                 </p>
                 </div>
              </div>
              </td>
            </tr>        
          </table>
      <table>
             <tr>
              <td>
                <div style='width:500px;'>
                </br>
              </br>
              <p class="pra">图例：</pra>
                  <p class="pra">a) Core 基因稀释曲线，横坐标表示抽取的样品个数；纵坐标表示抽取的样品组合的基因数目。</p> 
                  <p class="pra">b) Pan 基因稀释曲线，横坐标表示抽取的样品个数；纵坐标表示抽取的样品组合的基因数目。</p> 
                  <p class="pra">c) 样品间相关系数热图，不同颜色代表 spearman 相关系数的高低；相关系数与颜色间的关系见右侧图例说明；颜色越深代表样品间相关系数越大。</p>              
                </div>
              </td>
              <td rowspan='3' style='padding-left:25px;'></td>
              <td rowspan='3'>
                <p class ="pra">c</p>
                <div class='metagenome_info' style='width: 320px;'>
                 <div style="text-align:center;">
                 <p class="center"><a href="src/pictures/03.GeneComp/correlation.heatmap.png"><img  src="src/pictures/03.GeneComp/correlation.heatmap.png" width="110%" height="110%"/></a></p>
               </div>
                </div>
              </td>  
            </tr> 
      </table> 
OUT
;   }


    print OUT "
    <!---------------物种注释-------------->
    $taxonomy_dis_table
    ";
    if(-s "$report/src/pictures/04.Taxonomy/tax.bp.png"){
        print OUT << "OUT"
           <table>
            <a> <h3>物种丰度分析</h3></a>
              <tr>
              <td>
                <div style='width:900px;'>
                <p class="pra">从不同分类层级的相对丰度表出发，选取出在各样品中的最大相对丰度排名前 10 的物种，并将其余的物种设置为 Others，绘制出各样品对应的物种注释结果在不同分类层级上的相对丰度柱形图。</p>
                <p class="pra">为了研究不同样品的相似性，还可以通过对样品进行聚类分析，构建样品的聚类树。从基因在各样品中的丰度表出发，以 Bray-Curtis 距离矩阵进行样品间聚类分析，并将聚类结果与各样品在门水平上的物种相对丰度整合进行展示。</p>
                <p class="pra">主成分分析 (PCA，Principal Component Analysis)，是一种应用方差分解，对多维数据进行降维，从而提取出数据中最主要的元素和结构的方法。PCA 能够提取出最大程度反映样品间差异的两个坐标轴，从而将多维数据的差异反映在二维坐标图上，进而揭示复杂数据背景下的简单规律。
                <p class="pra">基于不同分类层级的物种丰度表，我们进行了 PCA 分析，如果样品的物种组成越相似，则它们在 PCA 图中的距离越接近。</p>
                 <p class="center">
                 <a href="src/pictures/04.Taxonomy/tax.bp.png"><img  src="src/pictures/04.Taxonomy/tax.bp.png" width="80%" height="80%"/></a>
                 </p>
                <p class="pra">图例：</p>
                <p class="pra">a) 样品聚类分析，左侧是 Bray-Curtis 距离聚类树结构；右侧的是各样品在门水平上的物种相对丰度分布图。</p>
                 <p class="pra">b) 门水平的 PCA 分析结果，横坐标表示第一主成分，百分比则表示第一主成分对样品差异的贡献值；纵坐标表示第二主成分，百分比表示第二主成分对样品差异的贡献值；图中的每个点表示一个样品，同一个组的样品使用同一种颜色表示。</p>
              </div>
              </td>
            </tr>     
    </table>
OUT
;
    }


    if (-s "$report/src/pictures/04.Taxonomy/meta.com.png" &&  -s "$report/src/pictures/04.Taxonomy/meta.com2.png"){
    print OUT << "OUT"
              <table>
      <a> <h3>物种显著性差异分析</h3></a>
             <tr>
              <td>
                <div style='width:400px;'>
               <p class="pra">为了研究组间具有显著性差异的物种，从不同层级的物种丰度表出发，利用 Metastats 方法对组间的物种丰度数据进行假设检验得到 p 值，通过对 p 值的校正，得到 q 值；最后根据 q 值筛选具有显著性差异的物种，并绘制差异物种在组间的丰度分布箱图。从差异分析结果出发，根据组间具有差异的物种进行主成分 PCA 分析和丰度聚类热图分析，展示结果如右图所示:</p>
             </br>
               <p class="pra">图例：</p>
               <p class="pra">a) 门水平差异物种丰度箱图；b) 门水平差异物种丰度箱图，图中，横轴为样品分组；纵向为对应物种的相对丰度。横线代表具有显著性差异的两个分组，没有则表示此物种在两个分组间不存在差异。“ * ”表示两组间差异显著（q value < 0.05），“ ** ”表示两组间差异极显著（q value < 0.01）；</p>
              <p class="pra">c) 基于显著性差异物种的 PCA 分析，横坐标表示第一主成分，百分比则表示第一主成分对样品差异的贡献值；纵坐标表示第二主成分，百分比表示第二主成分对样品差异的贡献值；图中的每个点表示一个样品，同一个组的样品使用同一种颜色表示；</p>
              <p class="pra">d) 基于显著性差异物种的丰度聚类热图,横向为样品信息；纵向为物种注释信息；图中左侧的聚类树为物种聚类树；中间热图对应的值为每一行物种相对丰度经过标准化处理后得到的 Z 值；</p>              
                </div>
              </td>
              <td rowspan='3' style='padding-left:25px;'></td>
              <td rowspan='3'>
                <div class='metagenome_info' style='width: 320px;'>
                 <div style="text-align:center;">
                 <p class="center"><a href="src/pictures/04.Taxonomy/meta.com.png"><img  src="src/pictures/04.Taxonomy/meta.com.png" width="150%" height="150%"/></a></p>
                 <p class="center"><a href="src/pictures/04.Taxonomy/meta.com2.png"><img  src="src/pictures/04.Taxonomy/meta.com2.png" width="150%" height="150%"/></a></p>
               </div>
                </div>
              </td>  
            </tr> 
      </table> 
OUT
;   }
    print OUT "
    <!---------------功能注释-------------->  
    $function_dis_table
    ";
    if(-s "$report/src/pictures/05.FunctionAnnotation/kegg.com.png" && -s "$report/src/pictures/05.FunctionAnnotation/kegg.com2.png"){
    print OUT << "OUT"
    <table>
      <a> <h3>KEGG 数据库注释结果分析</h3></a>
             <tr>
              <td>
                <div style='width:400px;'>
               <p class="pra">KEGG 数据库为一个综合性数据库，其中最核心的为 KEGG PATHWAY 和 KEGG ORTHOLOGY 数据库。在 KEGG PATHWAY 数据库中，将生物代谢通路划分为 6 类，分别为：细胞过程（Cellular Processes）、环境信息处理（Environmental Information Processing）、遗传信息处理（Genetic Information Processing）、人类疾病（Human Diseases）、新陈代谢（Metabolism）、生物体系统（Organismal Systems），KEGG 数据库在研究基因功能方面发挥着重要的作用，是 Metagenomics 分析中，必不可少的一部分。</p>
               </br>
               <p class="pra">图例：</p>
               <p class="pra">a) KEGG Unigenes 注释数目统计图，条形图上的数字代表注释上的 Unigenes 数目；其余一个坐标轴是各数据库中 level1 各功能类的代码，代码的解释见对应的图例说明；</p>
              <p class="pra">b) KEGG 数据库 level1 上的相对丰度柱形图，纵轴表示注释到某功能类的相对比例；横轴表示样品名称；各颜色区块对应的功能类别见右侧图例；</p>
              <p class="pra">c) KEGG 功能丰度聚类热图，横向为样品信息；纵向为功能注释信息；图中左侧的聚类树为功能聚类树；中间热图对应的值为每一行功能相对丰度经过标准化处理后得到的 Z 值；</p>
              <p class="pra">d) KEGG 功能丰度的 PCA 分析结果展示，横坐标表示第一主成分，百分比则表示第一主成分对样品差异的贡献值；纵坐标表示第二主成分，百分比表示第二主成分对样品差异的贡献值；图中的每个点表示一个样品，同一个组的样品使用同一种颜色表示；</p>
                </div>
              </td>
              <td rowspan='3' style='padding-left:25px;'></td>
              <td rowspan='3'>
                <div class='metagenome_info' style='width: 320px;'>
                 <div style="text-align:center;">
                 <p class="center"><a href="src/pictures/05.FunctionAnnotation/kegg.com.png"><img  src="src/pictures/05.FunctionAnnotation/kegg.com.png" width="170%" height="170%"/></a></p>
                 <p class="center"><a href="src/pictures/05.FunctionAnnotation/kegg.com2.png"><img  src="src/pictures/05.FunctionAnnotation/kegg.com2.png" width="170%" height="170%"/></a></p>
               </div>
                </div>
              </td>  
            </tr> 
      </table> 
OUT
;
    }
    if ($opt{ipath}){
        print OUT << "OUT"
              <table>
              <tr>
               <td>
                <div style='width:900px;'>
                  <h3>代谢通路分析</h3>
                  <p class="pra">为了研究不同分组（不同样品）在代谢通路图中的差异，绘制了代谢通路网页版结果展示，整体网页版报告分为两部分：</p>
     <p class="pra">第一部分为 KEGG 9 大 pathway overview 图，图中，展示了两个分组（或两个样品）共有及特有的代谢通路信息，在代谢通路图中，节点代表各种化合物，边代表一系列的酶类反应，红色代表两个分组（或两个样品）共有的酶类反应，蓝色代表分组 A（或样品 A）独有的酶类反应，绿色代表分组 B（或样品 B）独有的酶类反应；</p>
     <p class="pra">第二部分为注释到的 pathway 代谢通路图，在代谢通路图中，节点代表各种化合物, 方框代表酶类信息（默认边框为黑色，背景为白色），不同颜色的方框代表注释为该酶类的不同 Unigenes 数目，黄色背景的酶类代表在分组间具有显著差异的酶类（若没有进行显著差异分析，则没有此部分信息），鼠标移动至该酶类，可显示差异酶类在不同分组间的丰度分布箱图。</p>
     <p class="pra"><a href="src/pictures/05.FunctionAnnotation/pathwaymaps/pathway.html">展示结果请点击。</a></p>
                </div>
              </td>
            </tr>
            </table>
OUT
;   }

    print OUT "</br></br></br></br></br></br></body>";
    close OUT;
}
